<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AulIA - Plataforma de Simulaciones</title>
    <style>
        :root {
            --primary: #006A6A;
            --bg-color: #FFFFFF;
            --card-bg: #F8F9FA;
            --text-main: #212529;
            --radius: 12px;
            --font-family: 'Segoe UI', sans-serif;
            --chat-user: #e3f2fd;
            --chat-ai: #f1f8e9;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: var(--font-family); background-color: var(--bg-color); color: var(--text-main); }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }

        header { padding: 40px 20px; text-align: center; }
        .logo-container { margin-bottom: 20px; display: flex; justify-content: center; }
        .logo-img { max-width: 300px; height: auto; }
        .hero-desc { max-width: 700px; margin: 20px auto; font-size: 1.1rem; color: #555; }

        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px; padding: 20px 0; }
        .sim-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; padding: 20px 0; }

        .card { 
            background: var(--card-bg); 
            padding: 30px; 
            border-radius: var(--radius); 
            border: 1px solid #eee;
            transition: 0.3s;
            display: flex; flex-direction: column; justify-content: space-between;
        }
        .card:hover { transform: translateY(-5px); border-color: var(--primary); box-shadow: 0 10px 20px rgba(0,0,0,0.05); }
        .card h3 { color: var(--primary); margin-bottom: 10px; font-size: 1.2rem; }
        .card p { font-size: 0.95rem; color: #444; margin-bottom: 15px; }

        .case-container {
            background: #fff; padding: 30px; border-radius: var(--radius);
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 30px;
            border-left: 5px solid var(--primary);
        }
        .case-text { font-size: 1.05rem; line-height: 1.6; color: #333; white-space: pre-line; }
        .case-text ul { margin-left: 20px; margin-top: 10px; }

        .task-block { margin-top: 40px; border-top: 1px solid #eee; padding-top: 20px; }
        .task-title { font-weight: bold; color: var(--primary); font-size: 1.1rem; margin-bottom: 10px; }
        .task-desc { margin-bottom: 15px; color: #555; }

        .chat-box {
            background: #fff; border: 1px solid #ddd; border-radius: 8px;
            margin-top: 15px; display: flex; flex-direction: column; overflow: hidden;
        }
        .chat-header { 
            background: #f4f4f4; padding: 10px 15px; font-weight: bold; color: var(--primary);
            border-bottom: 1px solid #ddd;
        }
        .chat-messages {
            height: 300px; overflow-y: auto; padding: 15px; background: #fafafa;
            display: flex; flex-direction: column; gap: 10px;
        }
        .message { padding: 10px 15px; border-radius: 12px; max-width: 85%; font-size: 0.95rem; line-height: 1.4; }
        .msg-user { align-self: flex-end; background-color: var(--chat-user); color: #004d4d; border-bottom-right-radius: 2px; }
        .msg-ai { align-self: flex-start; background-color: var(--chat-ai); color: #2e7d32; border-bottom-left-radius: 2px; border: 1px solid #c8e6c9; }

        .chat-input-area { display: flex; gap: 10px; padding: 10px; background: #fff; border-top: 1px solid #eee; }
        .chat-input { flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 6px; }
        .chat-btn { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; }
        .card-sim { background: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 20px; text-align: center; color: #555; cursor: default; }
        .card-ia { background: #e6fcfc; border: 2px dashed var(--primary); cursor: pointer; color: var(--primary); font-weight: bold; }
        .btn { background: var(--primary); color: white; padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; width: 100%; margin-top: auto; }
        .hidden { display: none; }
        .breadcrumbs { margin: 20px 0; color: var(--primary); cursor: pointer; font-size: 0.9rem; }
    </style>
</head>
<body>

    <header>
        <div class="container">
            <div class="logo-container">
                <img src="logo.png" alt="Logo AulIA" class="logo-img" onerror="this.style.display='none'; document.getElementById('alt-logo').style.display='block'">
                <h1 id="alt-logo" style="display:none; color:var(--primary); font-size:2.5rem;">AulIA</h1>
            </div>
            <p class="hero-desc">Plataforma de simulaciones educativas basada en IA generativa. Practica la toma de decisiones y la reflexi√≥n docente en entornos profesionales seguros.</p>
        </div>
    </header>

    <div class="container">
        <div id="breadcrumbs" class="breadcrumbs hidden" onclick="app.goHome()"> Inicio </div>
        
        <section id="view-home"><div class="grid" id="degrees-grid"></div></section>
        
        <section id="view-subjects" class="hidden">
            <h2 id="degree-title" style="margin-bottom:20px; color:var(--primary)"></h2>
            <div class="grid" id="subjects-grid"></div>
        </section>

        <section id="view-levels" class="hidden">
            <h2 id="subject-title" style="margin-bottom:20px; color:var(--primary)"></h2>
            <div class="grid">
                <div class="card"><h3>Nivel 1</h3><button class="btn" onclick="app.loadSimulations(1)">Acceder</button></div>
                <div class="card"><h3>Nivel 2</h3><button class="btn" onclick="app.loadSimulations(2)">Acceder</button></div>
                <div class="card"><h3>Nivel 3</h3><button class="btn" onclick="app.loadSimulations(3)">Acceder</button></div>
            </div>
        </section>

        <section id="view-units" class="hidden">
            <h2 id="unit-subject-title" style="margin-bottom:20px; color:var(--primary)"></h2>
            <p style="margin-bottom:20px;">Selecciona la Unidad Competencial:</p>
            <div class="grid" id="units-grid"></div>
        </section>

        <section id="view-uc3-menu" class="hidden">
            <h2 style="margin-bottom:20px; color:var(--primary)">Unidad Competencial 3</h2>
            <div class="grid">
                <div class="card">
                    <h3>Actividad de la Unidad Competencial 3</h3>
                    <p>Resoluci√≥n de casos pr√°cticos evaluables.</p>
                    <button class="btn" onclick="app.loadUC3ActivityMenu()">Acceder</button>
                </div>
                <div class="card">
                    <h3>Pr√°ctica con simulaciones</h3>
                    <p>Entrenamiento pr√°ctico con diferentes niveles.</p>
                    <button class="btn" onclick="app.loadUC3PracticeLevels()">Acceder</button>
                </div>
            </div>
        </section>

        <section id="view-uc3-cases-menu" class="hidden">
            <h2 style="margin-bottom:20px; color:var(--primary)">Selecci√≥n de Caso de Estudio</h2>
            <div class="grid">
                <div class="card"><h3>Caso de Marina</h3><button class="btn" onclick="app.loadCase('marina')">Acceder</button></div>
                <div class="card"><h3>Caso de Ana√≠s</h3><button class="btn" onclick="app.loadCase('anais')">Acceder</button></div>
                <div class="card"><h3>Caso de Ra√∫l</h3><button class="btn" onclick="app.loadCase('raul')">Acceder</button></div>
                <div class="card"><h3>Caso de √Ångel</h3><button class="btn" onclick="app.loadCase('angel')">Acceder</button></div>
                <div class="card"><h3>Caso de Lu√≠s</h3><button class="btn" onclick="app.loadCase('luis')">Acceder</button></div>
            </div>
        </section>

        <section id="view-uc3-case-detail" class="hidden">
            <h2 id="case-title" style="margin-bottom:20px; color:var(--primary)"></h2>
            <div id="case-content" class="case-container"></div>
            <div id="case-tasks-container"></div>
        </section>

        <section id="view-uc3-levels" class="hidden">
            <h2 style="margin-bottom:20px; color:var(--primary)">UC3 - Pr√°ctica con simulaciones</h2>
            <div class="grid">
                <div class="card"><h3>Nivel 1 (F√°cil)</h3><p>Casos guiados, menor complejidad.</p><button class="btn" onclick="app.loadUC3SimGrid(1)">Acceder</button></div>
                <div class="card"><h3>Nivel 2 (Intermedio)</h3><p>Casos con m√°s variables y decisiones.</p><button class="btn" onclick="app.loadUC3SimGrid(2)">Acceder</button></div>
                <div class="card"><h3>Nivel 3 (Dif√≠cil)</h3><p>Casos complejos, dilemas.</p><button class="btn" onclick="app.loadUC3SimGrid(3)">Acceder</button></div>
            </div>
        </section>

        <section id="view-uc3-sims" class="hidden">
            <h2 id="uc3-sim-title" style="margin-bottom:20px; color:var(--primary)"></h2>
            <div id="uc3-sim-grid" class="sim-grid"></div>
        </section>

        <section id="view-simulations" class="hidden">
            <h2 id="level-title" style="margin-bottom:20px; color:var(--primary)"></h2>
            <div id="simulations-grid" class="sim-grid"></div>
        </section>
    </div>

    <script>
        // --- CEREBRO IA (ENTRENAMIENTO TE√ìRICO: UC3 TRASTORNOS DE LA COMUNICACI√ìN) ---
        // Este m√≥dulo gestiona la evaluaci√≥n pedag√≥gica basada en los documentos oficiales.
        //
        // MEJORA CLAVE (para evitar repetici√≥n):
        // 1) La IA usa MEMORIA por chat (caso+tarea) para no repetir las mismas ideas.
        // 2) La IA responde SIEMPRE sobre lo que el alumno ha escrito (extrae pistas del texto).
        // 3) La IA da retroalimentaci√≥n en 3 pasos: (a) lo que has dicho, (b) ajuste te√≥rico, (c) siguiente paso (una sola pregunta).
        // 4) La IA diferencia Tarea 1 / 2 / 3, as√≠ no devuelve el mismo argumento en todas.
        const tutorMemory = {
            chats: {},

            _mkKey(caseKey, taskId) { return `${caseKey}::${taskId}`; },

            get(caseKey, taskId) {
                const k = this._mkKey(caseKey, taskId);
                if (!this.chats[k]) {
                    this.chats[k] = {
                        usedSnippets: new Set(),   // ids de ideas ya usadas (para no repetir)
                        usedTags: new Set(),       // etiquetas sem√°nticas ya trabajadas
                        turns: []                  // historial simple (texto usuario y tipo)
                    };
                }
                return this.chats[k];
            },

            useSnippet(state, id, html) {
                if (state.usedSnippets.has(id)) return "";
                state.usedSnippets.add(id);
                return html;
            },

            useTag(state, tag) {
                if (state.usedTags.has(tag)) return false;
                state.usedTags.add(tag);
                return true;
            },

            pushTurn(state, who, text) {
                state.turns.push({ who, text, ts: Date.now() });
                if (state.turns.length > 12) state.turns.shift(); // l√≠mite simple
            }
        };

        // --- Helpers: normalizaci√≥n y detecci√≥n ---
        function normText(s) {
            return (s || "")
                .toLowerCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '')
                .replace(/\s+/g, ' ')
                .trim();
        }

        function hasAny(t, arr) { return arr.some(w => t.includes(w)); }
        function hasAll(t, arr) { return arr.every(w => t.includes(w)); }

        function excerpt(text, n=140) {
            const s = (text || "").trim();
            if (s.length <= n) return s;
            return s.slice(0, n).trim() + "‚Ä¶";
        }

        function countListItems(text) {
            // cuenta aproximada de √≠tems si el alumno escribe con:
            // - vi√±etas, saltos de l√≠nea, numeraci√≥n o separa por comas
            const raw = (text || "").trim();
            if (!raw) return 0;

            const lines = raw.split('\n').map(l => l.trim()).filter(Boolean);
            const bulletLike = lines.filter(l => /^(\-|\*|\d+[\.\)]|‚Ä¢)/.test(l)).length;

            if (bulletLike >= 2) return bulletLike;

            // Si no hay vi√±etas claras, estimaci√≥n por separadores
            const parts = raw.split(/[,;]+/).map(p => p.trim()).filter(p => p.length >= 3);
            return Math.min(Math.max(parts.length, 1), 20);
        }

        // --- Config UC3 (solo lo que aplica a estos casos) ---
        const uc3Configs = {
            marina: {
                label: "Marina",
                task1: {
                    correctCore: ["disfonia"],
                    lesion: ["nodulo", "nodulos"],
                    functionalBase: ["abuso vocal", "mal uso", "sobreesfuerzo", "hiperfunc", "higiene vocal", "grita", "gritar"],
                    evidence: ["voz grave", "gallo", "gallos", "inaudible", "forzada", "esfuerzo", "agudos", "cantar", "rigidez", "tono elevado", "fibroscopia", "orl"],
                    redFlags: ["cirugia", "operar", "quirurg", "farmac", "medicacion"],
                    wrongDx: ["disartria", "afasia", "tel", "disfasia", "neurolog"]
                },
                task2: {
                    indicators: [
                        { id:"gritos", label:"Abuso vocal (suele gritar)", keys:["grita","gritar","gritos","gritando"] },
                        { id:"esfuerzo", label:"Esfuerzo vocal al hablar", keys:["esfuerzo","forzada","forzado","tension","hiperfunc"] },
                        { id:"voz_grave", label:"Voz grave para su edad", keys:["voz grave","grave"] },
                        { id:"agudos", label:"Dificultad para emitir agudos / cantar", keys:["agudos","cantar","le cuesta cantar"] },
                        { id:"gallos", label:"Alteraciones fonatorias: 'gallos'", keys:["gallo","gallos"] },
                        { id:"inaudible", label:"Episodios de voz inaudible", keys:["inaudible","no se oye","no audible"] },
                        { id:"rigidez", label:"Rigidez / tono elevado en musculatura superior", keys:["rigidez","tono elevado","hipertonia","musculatura superior"] },
                        { id:"nodulos", label:"N√≥dulos vocales confirmados por ORL", keys:["nodulo","nodulos","orl","fibroscopia","nasolaringea"] }
                    ]
                },
                task3: {
                    must2: true,
                    inclusiveKeys: ["todo el grupo", "grupo clase", "aula", "asamblea", "toda la clase", "rutina de aula"],
                    preventiveKeys: ["prevencion", "higiene vocal", "pautas", "habitos", "cuidar la voz"],
                    activityKeys: ["juego", "actividad", "dinamica", "rutina", "cuento", "cartel", "registro", "sem√°foro", "semaforo"]
                }
            },

            anais: {
                label: "Ana√≠s",
                task1: {
                    correctCore: ["dislalia"],
                    subtype: ["fonet", "articul", "punto de articulacion", "praxias"],
                    evidence: ["seseo","rotacismo","omision","sinfones","asimilacion","coalescencia"],
                    redFlags: ["neurolog","cerebral","disartria"],
                    wrongDx: ["fonologico", "tel", "disfasia"]
                },
                task2: { indicators: [] },
                task3: { must2: true, inclusiveKeys: ["grupo clase","aula"], preventiveKeys: ["prevencion"], activityKeys: ["praxias","soplo","discriminacion","juego"] }
            },

            raul: {
                label: "Ra√∫l",
                task1: {
                    correctCore: ["fonologico", "trastorno fonologico"],
                    evidence: ["metatesis","inversion","omision","estructura","secuencia","bosch","simplificacion"],
                    redFlags: ["frenillo","musc", "praxias", "soplo"],
                    wrongDx: ["dislalia", "disglosia"]
                },
                task2: { indicators: [] },
                task3: { must2: true, inclusiveKeys: ["grupo clase","aula"], preventiveKeys: ["prevencion"], activityKeys: ["conciencia fonologica","segmentacion","rimas","silabas"] }
            },

            angel: {
                label: "√Ångel",
                task1: {
                    correctCore: ["disglosia"],
                    evidence: ["frenillo","anquiloglosia","malformacion"],
                    redFlags: ["solo logopedia","solo ejercicios"],
                    wrongDx: ["dislalia funcional", "fonologico"]
                },
                task2: { indicators: [] },
                task3: { must2: true, inclusiveKeys: ["grupo clase","aula"], preventiveKeys: ["prevencion"], activityKeys: ["apoyo emocional","convivencia","respeto"] }
            },

            luis: {
                label: "Lu√≠s",
                task1: {
                    correctCore: ["disartria"],
                    evidence: ["espasticidad","debilidad","monotono","tono bajo","lenta","rigidez"],
                    redFlags: ["solo tartamudez","solo disfemia"],
                    wrongDx: ["disfemia", "tartamudeo"]
                },
                task2: { indicators: [] },
                task3: { must2: true, inclusiveKeys: ["grupo clase","aula"], preventiveKeys: ["prevencion"], activityKeys: ["derivacion","equipo","apoyos"] }
            }
        };

        function buildFeedbackHeader(text) {
            const e = excerpt(text, 160);
            return `He le√≠do tu respuesta: <i>‚Äú${e || "‚Ä¶" }‚Äù</i><br><br>`;
        }

        function buildNextStepQuestion(state, id, qHtml) {
            // una sola pregunta final, sin repetir preguntas previas
            const out = tutorMemory.useSnippet(state, id, `<b>Pregunta de avance:</b> ${qHtml}`);
            return out || `<b>Pregunta de avance:</b> ¬øQu√© evidencia concreta del caso usar√≠as para reforzar tu argumento?`;
        }

        function task1Engine(caseKey, text, state) {
            const cfg = uc3Configs[caseKey]?.task1;
            const t = normText(text);

            const parts = [];
            parts.push(buildFeedbackHeader(text));

            // Red flags: intervenci√≥n invasiva / medicaci√≥n
            if (cfg?.redFlags && hasAny(t, cfg.redFlags)) {
                const s = tutorMemory.useSnippet(
                    state,
                    `${caseKey}_t1_redflag_invasiva`,
                    `‚ö†Ô∏è <b>Ajuste:</b> Est√°s proponiendo una v√≠a invasiva/medicada. En este tipo de casos, antes se prioriza identificar el tipo de trastorno y la intervenci√≥n educativa/logop√©dica coherente con la causa del caso.<br><br>`
                );
                if (s) parts.push(s);
            }

            // Diagn√≥stico claramente equivocado (por etiqueta)
            if (cfg?.wrongDx && hasAny(t, cfg.wrongDx)) {
                const s = tutorMemory.useSnippet(
                    state,
                    `${caseKey}_t1_wrongdx`,
                    `üõë <b>Revisi√≥n conceptual:</b> En tu texto aparecen etiquetas que no encajan con las evidencias del caso. Relee la descripci√≥n y alinea tu diagn√≥stico con los datos observables y el informe aportado.<br><br>`
                );
                if (s) parts.push(s);
            }

            // Diagn√≥stico correcto (n√∫cleo)
            let mentionsCore = cfg?.correctCore ? hasAny(t, cfg.correctCore) : false;

            // Para Marina: adem√°s, reforzar con lesi√≥n + base funcional
            if (caseKey === "marina") {
                const mentionsLesion = cfg?.lesion ? hasAny(t, cfg.lesion) : false;
                const mentionsFunctional = cfg?.functionalBase ? hasAny(t, cfg.functionalBase) : false;

                if (mentionsCore && mentionsLesion) {
                    const s = tutorMemory.useSnippet(
                        state,
                        `marina_t1_ok_core`,
                        `‚úÖ <b>Bien orientado:</b> Nombras <b>disfon√≠a</b> y conectas con los <b>n√≥dulos</b>. Eso encaja con el informe ORL y con la sintomatolog√≠a (esfuerzo vocal, ‚Äúgallos‚Äù, dificultad con agudos).<br><br>`
                    );
                    if (s) parts.push(s);
                } else if (mentionsLesion && !mentionsCore) {
                    const s = tutorMemory.useSnippet(
                        state,
                        `marina_t1_missing_label`,
                        `üîé <b>Te falta afinar la etiqueta:</b> Has detectado la lesi√≥n (‚Äún√≥dulos‚Äù), pero falta nombrar el trastorno paraguas: <b>trastorno de la voz (disfon√≠a)</b>.<br><br>`
                    );
                    if (s) parts.push(s);
                } else if (!mentionsLesion && mentionsCore) {
                    const s = tutorMemory.useSnippet(
                        state,
                        `marina_t1_missing_lesion`,
                        `üîé <b>Te falta incorporar una evidencia clave:</b> Si hablas de disfon√≠a, ap√≥yate en el dato cl√≠nico del caso: el informe ORL identifica <b>n√≥dulos vocales</b>.<br><br>`
                    );
                    if (s) parts.push(s);
                } else {
                    const s = tutorMemory.useSnippet(
                        state,
                        `marina_t1_prompt_core`,
                        `Para resolver la Tarea 1, escribe tu hip√≥tesis con esta estructura: <b>(1) trastorno</b>, <b>(2) subtipo</b> y <b>(3) 2‚Äì3 evidencias del texto</b>.<br><br>`
                    );
                    if (s) parts.push(s);
                }

                if (mentionsCore && mentionsLesion && !mentionsFunctional) {
                    const s = tutorMemory.useSnippet(
                        state,
                        `marina_t1_subtype_needed`,
                        `üí° <b>Subtipo:</b> Te falta justificar la base funcional del problema (p. ej., <i>abuso vocal</i> por gritos) que desemboca en una lesi√≥n. Ese matiz mejora la precisi√≥n del subtipo.<br><br>`
                    );
                    if (s) parts.push(s);
                }
            } else {
                // Otros casos: si menciona n√∫cleo + evidencias
                if (mentionsCore) {
                    const s = tutorMemory.useSnippet(
                        state,
                        `${caseKey}_t1_ok`,
                        `‚úÖ <b>Bien:</b> Nombras la categor√≠a principal. Ahora refu√©rzala citando 2 evidencias literales del caso (sustituciones, omisiones, signos org√°nicos, etc.).<br><br>`
                    );
                    if (s) parts.push(s);
                } else {
                    const s = tutorMemory.useSnippet(
                        state,
                        `${caseKey}_t1_prompt`,
                        `Escribe tu hip√≥tesis indicando <b>diagn√≥stico</b> + <b>subtipo</b> (si procede) + <b>evidencias</b> (m√≠nimo 2) tomadas del texto del caso.<br><br>`
                    );
                    if (s) parts.push(s);
                }
            }

            // Pregunta final (una sola)
            if (caseKey === "marina") {
                parts.push(buildNextStepQuestion(
                    state,
                    `marina_t1_q`,
                    `¬øQu√© dos evidencias exactas del caso usar√≠as para justificar el <b>subtipo</b> (base funcional por abuso vocal + lesi√≥n) en una frase?`
                ));
            } else {
                parts.push(buildNextStepQuestion(
                    state,
                    `${caseKey}_t1_q`,
                    `¬øQu√© evidencia del texto es la m√°s fuerte para justificar tu diagn√≥stico y por qu√©?`
                ));
            }

            return parts.join('');
        }

        function task2Engine(caseKey, text, state) {
            const cfg = uc3Configs[caseKey]?.task2;
            const t = normText(text);

            const parts = [];
            parts.push(buildFeedbackHeader(text));

            if (!cfg || !cfg.indicators || cfg.indicators.length === 0) {
                const s = tutorMemory.useSnippet(
                    state,
                    `${caseKey}_t2_generic`,
                    `Para esta tarea, lista <b>m√≠nimo 6</b> indicadores presentes en el caso (conductuales, observacionales y cl√≠nicos). Intenta que cada indicador est√© ligado a una frase del caso.<br><br>`
                );
                if (s) parts.push(s);

                parts.push(buildNextStepQuestion(
                    state,
                    `${caseKey}_t2_q`,
                    `¬øPuedes escribir 6 indicadores en vi√±etas y, al lado, la frase del caso que los respalda?`
                ));
                return parts.join('');
            }

            // Marina: comprobar cu√°ntos indicadores menciona (de la lista esperada)
            const mentioned = [];
            const missing = [];

            cfg.indicators.forEach(ind => {
                if (hasAny(t, ind.keys)) mentioned.push(ind);
                else missing.push(ind);
            });

            const approxCount = countListItems(text);
            const sCount = tutorMemory.useSnippet(
                state,
                `marina_t2_count`,
                `üìå <b>Revisi√≥n r√°pida:</b> En tu respuesta se aprecian aproximadamente <b>${approxCount}</b> √≠tems. En el caso, los indicadores m√°s caracter√≠sticos se concentran en <b>abuso vocal</b>, <b>signos de disfon√≠a</b> y <b>confirmaci√≥n ORL</b>.<br><br>`
            );
            if (sCount) parts.push(sCount);

            if (mentioned.length > 0) {
                const ids = mentioned.map(m => `‚Ä¢ ${m.label}`).join('<br>');
                const s = tutorMemory.useSnippet(
                    state,
                    `marina_t2_what_you_got`,
                    `‚úÖ <b>Indicadores que has activado con tu texto:</b><br>${ids}<br><br>`
                );
                if (s) parts.push(s);
            } else {
                const s = tutorMemory.useSnippet(
                    state,
                    `marina_t2_none`,
                    `üîé <b>Te falta aterrizar indicadores del caso:</b> No detecto en tu texto referencias claras a los indicadores t√≠picos (gritos, esfuerzo, ‚Äúgallos‚Äù, agudos/canto, rigidez, n√≥dulos).<br><br>`
                );
                if (s) parts.push(s);
            }

            // Sugerir faltantes, sin repetir
            const newMissing = missing.filter(m => tutorMemory.useTag(state, `miss_${m.id}`));
            if (newMissing.length > 0) {
                const ids = newMissing.slice(0, 6).map(m => `‚Ä¢ ${m.label}`).join('<br>');
                const s = tutorMemory.useSnippet(
                    state,
                    `marina_t2_missing`,
                    `üß© <b>Para completar hasta 6‚Äì8 indicadores del caso, a√±ade:</b><br>${ids}<br><br>`
                );
                if (s) parts.push(s);
            }

            parts.push(buildNextStepQuestion(
                state,
                `marina_t2_q`,
                `De los indicadores que has listado, ¬øcu√°l consideras el <b>factor desencadenante</b> y cu√°l el <b>signo cl√≠nico confirmado</b>?`
            ));

            return parts.join('');
        }

        function task3Engine(caseKey, text, state) {
            const cfg = uc3Configs[caseKey]?.task3;
            const t = normText(text);

            const parts = [];
            parts.push(buildFeedbackHeader(text));

            const approxCount = countListItems(text);
            const hasTwo = approxCount >= 2;

            const hasInclusive = cfg?.inclusiveKeys ? hasAny(t, cfg.inclusiveKeys.map(k => normText(k))) : false;
            const hasPreventive = cfg?.preventiveKeys ? hasAny(t, cfg.preventiveKeys.map(k => normText(k))) : false;
            const hasActivity = cfg?.activityKeys ? hasAny(t, cfg.activityKeys.map(k => normText(k))) : false;

            if (!hasTwo) {
                const s = tutorMemory.useSnippet(
                    state,
                    `${caseKey}_t3_need_two`,
                    `üß© <b>Te falta cumplir el requisito:</b> La tarea pide <b>2 actividades</b>. Escr√≠belas separadas (Actividad 1 / Actividad 2) y concreta: objetivo, pasos y duraci√≥n breve.<br><br>`
                );
                if (s) parts.push(s);
            }

            if (!hasInclusive) {
                const s = tutorMemory.useSnippet(
                    state,
                    `${caseKey}_t3_need_inclusive`,
                    `üë• <b>Inclusi√≥n:</b> Incluye al menos una actividad pensada para <b>todo el grupo clase</b> (no s√≥lo intervenci√≥n individual).<br><br>`
                );
                if (s) parts.push(s);
            }

            if (!hasPreventive) {
                const s = tutorMemory.useSnippet(
                    state,
                    `${caseKey}_t3_need_preventive`,
                    `üõ°Ô∏è <b>Prevenci√≥n:</b> Explicita que una de las actividades es <b>preventiva</b> (pautas/h√°bitos/rutinas) y qu√© riesgo intenta reducir.<br><br>`
                );
                if (s) parts.push(s);
            }

            if (!hasActivity) {
                const s = tutorMemory.useSnippet(
                    state,
                    `${caseKey}_t3_need_concrete`,
                    `üîß <b>Concreci√≥n:</b> A√±ade una din√°mica concreta (juego, rutina, registro, cuento, cartel, etc.) para que la actividad sea aplicable en el aula.<br><br>`
                );
                if (s) parts.push(s);
            }

            parts.push(buildNextStepQuestion(
                state,
                `${caseKey}_t3_q`,
                `De tus dos actividades, ¬øcu√°l es la <b>preventiva e inclusiva</b> y qu√© indicador del caso busca reducir?`
            ));

            return parts.join('');
        }

        function evaluateUC3(caseKey, taskId, text, state) {
            // Derivador por tarea (para evitar que repita el mismo argumento siempre)
            if (taskId === 1) return task1Engine(caseKey, text, state);
            if (taskId === 2) return task2Engine(caseKey, text, state);
            if (taskId === 3) return task3Engine(caseKey, text, state);
            return "Interesante planteamiento. ¬øPuedes concretar a qu√© tarea respondes (1, 2 o 3) y justificarlo con evidencias del caso?";
        }

        // --- CEREBRO IA por caso ---
        const aiBrain = {
            marina: {
                evaluate: (text, taskId, state) => evaluateUC3("marina", taskId, text, state)
            },
            anais: {
                evaluate: (text, taskId, state) => evaluateUC3("anais", taskId, text, state)
            },
            raul: {
                evaluate: (text, taskId, state) => evaluateUC3("raul", taskId, text, state)
            },
            angel: {
                evaluate: (text, taskId, state) => evaluateUC3("angel", taskId, text, state)
            },
            luis: {
                evaluate: (text, taskId, state) => evaluateUC3("luis", taskId, text, state)
            }
        };

        const casesData = {
            marina: `
                <strong>Antecedentes:</strong> Marina es una ni√±a de 5 a√±os que tiene una voz ligeramente grave en relaci√≥n con su constituci√≥n y edad, y parece que realiza un gran esfuerzo vocal cuando habla.<br><br>
                <strong>Observaci√≥n:</strong> Le cuesta cantar y tiene dificultades para emitir sonidos agudos. Tiene tambi√©n alteraciones fonatorias como "gallos", y en ocasiones produce sonidos inaudibles y muy forzados. Presenta una musculatura superior con un tono elevado, con rigidez.<br><br>
                <strong>Factores:</strong> En cuanto a los factores predisponentes, es una ni√±a que suele gritar, aunque no presenta afectaciones pulmonares ni un ambiente familiar excitado o excesivamente ruidoso.<br><br>
                <strong>Informe M√©dico:</strong> El informe de la ORL mediante la fibroscopia nasolar√≠ngea expone que se aprecian n√≥dulos vocales.
            `,
            anais: `
                <strong>Antecedentes:</strong> Ana√Øs es una ni√±a de 5 a√±os que presenta un lenguaje que la AL ha descrito como ‚Äúinfantilizado‚Äù.<br><br>
                <strong>Alteraciones observadas (Dislalias):</strong>
                <ul>
                    <li>Seseo (sustituci√≥n de /c/ por /s/, por ejemplo, cigarro por sigarro, zapato por sapato).</li>
                    <li>Rotacismo (sustituci√≥n del fonema /rr/ por /l/ o /r/, por ejemplo, rat√≥n por lat√≥n).</li>
                    <li>Omisi√≥n del sonido /r/ a final de palabra (collar por coll√°).</li>
                    <li>Omisi√≥n del fonema /s/ en posici√≥n inversa (espada por epada).</li>
                    <li>Simplificaci√≥n de sinfones vibrantes y l√≠quidos (globo por lobo, brazo por blazo).</li>
                </ul>
                <br><em>Nota: Los errores son sistem√°ticos y de ejecuci√≥n motriz.</em>
            `,
            raul: `
                <strong>Situaci√≥n:</strong> Ra√∫l articula bien aisladamente, pero falla en la secuencia.<br><br>
                <strong>FON√âTICAMENTE:</strong> sabe y puede articular todos los fonemas (salvo algunos grupos complejos), pero...<br><br>
                <strong>FONOL√ìGICAMENTE:</strong> encontramos procesos de simplificaci√≥n del habla seg√∫n Laura Bosch (1983):
                <ul>
                    <li>Met√°tesis o inversi√≥n: /lim√≥n/ por /mil√≥n/.</li>
                    <li>Omisiones de consonantes finales e iniciales.</li>
                    <li>Omisi√≥n de s√≠labas √°tonas (/escoba/ por /coba/).</li>
                </ul>
                <br><em>Clave: El problema es de organizaci√≥n mental del sonido, no de ejecuci√≥n muscular.</em>
            `,
            angel: `
                <strong>Relato del alumno:</strong> ‚ÄúHola mi nombrle es √Ångel y teno chinco a√±os‚Ä¶ mis maestlas piensan que hablo as√≠, ¬°¬°que ponque estoy mimado!!‚Äù<br><br>
                <strong>Informaci√≥n familiar (CLAVE):</strong> Su padre nos dice que tiene una malformaci√≥n del frenillo lingual (Anquiloglosia). √âste es demasiado corto, lo que le impide f√≠sicamente pronunciar ciertos fonemas.
            `,
            luis: `
                <strong>Relato del alumno:</strong> ‚ÄúHooollaaa mii nooombreee eess Luuu√≠√≠sss...‚Äù (Habla lenta, costosa).<br><br>
                <strong>Informaci√≥n familiar (Signos de Alerta):</strong> Su madre indica que:
                <ul>
                    <li>Es lento en el habla.</li>
                    <li>Tono bajo y mon√≥tono.</li>
                    <li>Muestra <strong>debilidad y espasticidad</strong> en un lado del cuerpo, lengua y labios.</li>
                </ul>
                <em>Nota: La espasticidad sugiere origen neurol√≥gico, no solo un problema de fluidez.</em>
            `
        };

        const tasks = [
            { id: 1, title: "TAREA 1: Identificaci√≥n del trastorno", desc: "Identificar el posible trastorno y subtipo para el caso, haciendo referencia a evidencias del texto. Argumenta la respuesta bas√°ndote en los manuales de la asignatura." },
            { id: 2, title: "TAREA 2: Indicadores de riesgo", desc: "Elaborar una lista con los indicadores de riesgo M√ÅS CARACTER√çSTICOS presentes en el caso (m√≠nimo 6)." },
            { id: 3, title: "TAREA 3: Propuesta de intervenci√≥n", desc: "Describir 2 actividades adecuadas para trabajar tempranamente los indicadores descritos. <br><strong>REQUISITO:</strong> Al menos una actividad debe ser inclusiva (para todo el grupo clase) y preventiva." }
        ];

        const data = {
            degrees: [
                { 
                    id: '1', title: 'M√°ster Universitario en Formaci√≥n del Profesorado', 
                    subjects: [{code:'01MSEC', name:'01MSEC_Aprendizaje y desarrollo de la personalidad'}, {code:'03MSEC', name:'03MSEC_Sociedad, familia y educaci√≥n'}] 
                },
                { 
                    id: '2', title: 'M√°ster Universitario en Metodolog√≠as Activas y Digitales', 
                    subjects: [{code:'02MADI', name:'02MADI_Habilidades Docentes Avanzadas para el Aprendizaje'}] 
                },
                { 
                    id: '3', title: 'Grado Universitario en Educaci√≥n Infantil', 
                    subjects: [
                        {code:'43GEIN', name:'43GEIN_04_A_2026-27_Dificultades en el aprendizaje, trastornos de la comunicaci√≥n y TDA / hiperactividad'}, 
                        {code:'8GEIN', name:'8GEIN_04_A_2026-27_Estimulaci√≥n del lenguaje oral'}
                    ] 
                }
            ]
        };

        const app = {
            history: [], 

            show(id) {
                document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
                document.getElementById(id).classList.remove('hidden');
                const bc = document.getElementById('breadcrumbs');
                if (id === 'view-home') { bc.classList.add('hidden'); this.history = []; } 
                else { bc.classList.remove('hidden'); this.updateBreadcrumbs(); }
            },

            updateBreadcrumbs() {
                const bc = document.getElementById('breadcrumbs');
                let text = "Inicio";
                if (this.history.length > 0) text += " > " + this.history[this.history.length-1];
                bc.innerText = "< " + text;
            },

            goHome() { this.renderDegrees(); },

            renderDegrees() {
                this.history = [];
                const g = document.getElementById('degrees-grid');
                g.innerHTML = '';
                data.degrees.forEach(d => {
                    g.innerHTML += `<div class="card"><h3>${d.title}</h3><p>Accede a las asignaturas disponibles.</p><button class="btn" onclick="app.loadDegree('${d.id}')">Ver Asignaturas</button></div>`;
                });
                this.show('view-home');
            },

            loadDegree(id) {
                const d = data.degrees.find(x => x.id === id);
                this.history = [d.title]; 
                document.getElementById('degree-title').innerText = d.title;
                const g = document.getElementById('subjects-grid');
                g.innerHTML = '';
                d.subjects.forEach(s => {
                    g.innerHTML += `<div class="card"><h3>${s.code}</h3><p>${s.name}</p><button class="btn" onclick="app.loadSubject('${s.name}')">Acceder</button></div>`;
                });
                this.show('view-subjects');
            },

            loadSubject(fullName) {
                this.history.push("Asignatura");
                const especialSubject = '43GEIN_04_A_2026-27_Dificultades en el aprendizaje, trastornos de la comunicaci√≥n y TDA / hiperactividad';
                if (fullName === especialSubject) {
                    document.getElementById('unit-subject-title').innerText = fullName;
                    const g = document.getElementById('units-grid');
                    g.innerHTML = '';
                    g.innerHTML += `<div class="card"><h3>Unidad Competencial 2</h3><button class="btn" onclick="alert('Pr√≥ximamente')">Entrar</button></div>`;
                    g.innerHTML += `<div class="card"><h3>Unidad Competencial 3</h3><p>Acceso a Actividades y Simulaciones.</p><button class="btn" onclick="app.loadUC3Menu()">Entrar</button></div>`;
                    g.innerHTML += `<div class="card"><h3>Unidad Competencial 4</h3><button class="btn" onclick="alert('Pr√≥ximamente')">Entrar</button></div>`;
                    this.show('view-units');
                } else {
                    document.getElementById('subject-title').innerText = fullName;
                    this.show('view-levels');
                }
            },

            loadUC3Menu() {
                this.history.push("UC3");
                this.show('view-uc3-menu');
            },

            loadUC3ActivityMenu() {
                this.history.push("Actividad");
                this.show('view-uc3-cases-menu');
            },

            loadCase(caseKey) {
                const names = { marina: "Caso de Marina", anais: "Caso de Ana√≠s", raul: "Caso de Ra√∫l", angel: "Caso de √Ångel", luis: "Caso de Lu√≠s" };
                this.history.push(names[caseKey]);
                document.getElementById('case-title').innerText = names[caseKey];
                document.getElementById('case-content').innerHTML = `<div class="case-text">${casesData[caseKey]}</div>`;
                
                const tasksContainer = document.getElementById('case-tasks-container');
                tasksContainer.innerHTML = '';
                
                tasks.forEach(task => {
                    const chatId = `chat-${caseKey}-${task.id}`;
                    tasksContainer.innerHTML += `
                        <div class="task-block">
                            <div class="task-title">${task.title}</div>
                            <p class="task-desc">${task.desc}</p>
                            <div class="chat-box">
                                <div class="chat-header"><span>üí¨ Tutor Virtual AulIA</span></div>
                                <div class="chat-messages" id="${chatId}">
                                    <div class="message msg-ai">Hola. Soy AulIA, tu tutor virtual. He analizado el caso. ¬øCu√°l es tu hip√≥tesis inicial para esta tarea? Recuerda justificar con la teor√≠a.</div>
                                </div>
                                <div class="chat-input-area">
                                    <input type="text" class="chat-input" id="input-${chatId}" placeholder="Escribe tu an√°lisis aqu√≠..." onkeypress="if(event.key==='Enter') app.sendMessage('${caseKey}', ${task.id})">
                                    <button class="chat-btn" onclick="app.sendMessage('${caseKey}', ${task.id})">Enviar</button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                this.show('view-uc3-case-detail');
            },

            sendMessage(caseKey, taskId) {
                const chatId = `chat-${caseKey}-${taskId}`;
                const input = document.getElementById(`input-${chatId}`);
                const text = input.value.trim();
                if (!text) return;

                const msgContainer = document.getElementById(chatId);
                msgContainer.innerHTML += `<div class="message msg-user">${text}</div>`;
                input.value = '';
                msgContainer.scrollTop = msgContainer.scrollHeight;

                const loadingId = `loading-${Date.now()}`;
                msgContainer.innerHTML += `<div id="${loadingId}" class="message msg-ai" style="opacity:0.7">Analizando respuesta...</div>`;
                msgContainer.scrollTop = msgContainer.scrollHeight;

                // MEMORIA por chat (caso + tarea)
                const state = tutorMemory.get(caseKey, taskId);
                tutorMemory.pushTurn(state, "user", text);

                setTimeout(() => {
                    document.getElementById(loadingId).remove();
                    // Usar el cerebro entrenado (ahora con taskId + memoria para evitar repetici√≥n)
                    let response = "Interesante planteamiento. ¬øPodr√≠as detallar m√°s en qu√© te basas?";
                    if(aiBrain[caseKey] && aiBrain[caseKey].evaluate) {
                        response = aiBrain[caseKey].evaluate(text, taskId, state);
                    }

                    tutorMemory.pushTurn(state, "ai", response);

                    msgContainer.innerHTML += `<div class="message msg-ai">${response}</div>`;
                    msgContainer.scrollTop = msgContainer.scrollHeight;
                }, 700);
            },

            loadUC3PracticeLevels() { this.history.push("Pr√°ctica"); this.show('view-uc3-levels'); },

            loadUC3SimGrid(level) {
                this.history.push("Nivel " + level);
                document.getElementById('uc3-sim-title').innerText = "UC3 - Pr√°ctica - Nivel " + level;
                const g = document.getElementById('uc3-sim-grid');
                g.innerHTML = '';
                for(let i=1; i<=20; i++) g.innerHTML += `<div class="card-sim"><strong>Simulaci√≥n ${i}</strong></div>`;
                g.innerHTML += `<div class="card-sim card-ia" onclick="alert('Generando nueva simulaci√≥n con IA...')"><strong>+ Acceso a m√°s simulaciones generadas por IA</strong></div>`;
                this.show('view-uc3-sims');
            },

            loadSimulations(n) {
                this.history.push("Nivel " + n);
                document.getElementById('level-title').innerText = "Simulaciones - Nivel " + n;
                const g = document.getElementById('simulations-grid');
                g.innerHTML = '';
                for(let i=1; i<=20; i++) g.innerHTML += `<div class="card-sim"><strong>Simulaci√≥n ${i}</strong></div>`;
                this.show('view-simulations');
            }
        };

        app.renderDegrees();
    </script>
</body>
</html>
