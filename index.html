// --- CEREBRO IA: TUTOR UC3 (ESTILO NOTEBOOKLM) ---
        
        // 1. BASE DE CONOCIMIENTO (Citas textuales de los documentos adjuntos)
        const knowledgeBase = {
            general: {
                scope: "Evidencia: 'UC3 - Trastornos de la Comunicaci√≥n'. Mi √°mbito es √∫nicamente la detecci√≥n e intervenci√≥n educativa en alteraciones del lenguaje oral en Educaci√≥n Infantil."
            },
            marina: {
                diagnosis: "Disfon√≠a (Trastorno de la voz). Evidencia: 'UC3 - Trastornos de la Comunicaci√≥n'. Afecta a tono, timbre e intensidad.",
                etiology: "Disfon√≠a Funcional por abuso vocal (gritos) que deriva en lesi√≥n org√°nica (n√≥dulos). Evidencia: Informe ORL citado en el caso.",
                indicators: "Indicadores clave: Esfuerzo vocal, 'gallos', voz grave para su edad, rigidez muscular. (Ref: 'Signos de riesgo', 43 GEIN UC3).",
                intervention: "Intervenci√≥n: Higiene vocal, relajaci√≥n y reeducaci√≥n respiratoria. Evidencia: 'Pautas de higiene vocal' (Material de estudio UC3)."
            },
            anais: {
                diagnosis: "Dislalia (Trastorno fon√©tico). Evidencia: '43 GEIN UC3 - Alteraciones del Lenguaje'. Errores motrices sistem√°ticos.",
                details: "Tipos de error: Sustituci√≥n (seseo), Omisi√≥n (final de palabra), Simplificaci√≥n. No es fonol√≥gico porque falla la ejecuci√≥n motriz.",
                intervention: "Actividades: Praxias bucofonatorias, soplo y discriminaci√≥n auditiva. Evidencia: 'V√≠deos sobre PRAXIAS' y 'Ejercicios de estimulaci√≥n' (Material UC3)."
            },
            raul: {
                diagnosis: "Trastorno Fonol√≥gico (Retraso del habla). Evidencia: '43 GEIN UC3'. Articula bien aisladamente pero falla en la secuencia.",
                details: "Procesos de simplificaci√≥n (Laura Bosch, 1983): Met√°tesis, omisiones de s√≠labas √°tonas. Problema de organizaci√≥n mental del sonido.",
                intervention: "Actividades: Conciencia fonol√≥gica, rimas, segmentaci√≥n sil√°bica. Evidencia: 'Intervenci√≥n temprana' (Material UC3)."
            },
            angel: {
                diagnosis: "Disglosia (Trastorno org√°nico). Evidencia: 'UC3 - Trastornos de la Comunicaci√≥n'. Alteraci√≥n por malformaci√≥n en √≥rganos del habla.",
                details: "Causa: Anquiloglosia (frenillo lingual corto). Impide la articulaci√≥n f√≠sica.",
                intervention: "Enfoque: No forzar articulaci√≥n imposible sin valoraci√≥n m√©dica previa. Trabajo de compensaci√≥n y autoestima."
            },
            luis: {
                diagnosis: "Disartria (Componente neurol√≥gico). Evidencia: 'DSM-5' / 'UC3'. Debilidad y espasticidad muscular.",
                redFlag: "No confundir con Disfemia. La lentitud y tono bajo son por la espasticidad, no por bloqueos de fluidez.",
                intervention: "Intervenci√≥n: SAAC (si fuera necesario), relajaci√≥n, trabajo multidisciplinar con fisioterapia."
            }
        };

        // 2. MEMORIA DEL TUTOR
        const tutorMemory = {
            chats: {},
            _mkKey(caseKey, taskId) { return `${caseKey}::${taskId}`; },
            get(caseKey, taskId) {
                const k = this._mkKey(caseKey, taskId);
                if (!this.chats[k]) {
                    this.chats[k] = { usedSnippets: new Set(), turns: [] };
                }
                return this.chats[k];
            },
            pushTurn(state, who, text) {
                state.turns.push({ who, text, ts: Date.now() });
            },
            hasUsed(state, id) { return state.usedSnippets.has(id); },
            markUsed(state, id) { state.usedSnippets.add(id); }
        };

        // 3. UTILIDADES DE TEXTO
        function normText(s) {
            return (s || "").toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').trim();
        }
        function hasAny(t, arr) { return arr.some(w => t.includes(w)); }
        function excerpt(text, n=100) { return text.length > n ? text.slice(0, n) + "..." : text; }

        // 4. CONFIGURACI√ìN DE CASOS (Reglas de evaluaci√≥n pedag√≥gica)
        const uc3Rules = {
            marina: {
                t1: {
                    keywords: ["disfonia", "trastorno de la voz"],
                    evidenceReq: ["nodulo", "gritos", "esfuerzo"],
                    feedbackOK: "Correcto. Identificas la **Disfon√≠a** (alteraci√≥n de la voz).",
                    feedbackMiss: "Revisa el concepto. ¬øEs un problema de articulaci√≥n (habla) o de emisi√≥n (voz)? F√≠jate en la 'ronquera' y los 'gallos'."
                },
                t2: {
                    minIndicators: 6,
                    keywords: ["grita", "esfuerzo", "voz grave", "agudos", "gallos", "inaudible", "rigidez", "nodulos"],
                },
                t3: {
                    req: ["higiene vocal", "respiracion", "relajacion"],
                    inclusive: ["sem√°foro", "cartel", "cuento", "rutina"]
                }
            },
            anais: { // Dislalia
                t1: {
                    keywords: ["dislalia"],
                    evidenceReq: ["seseo", "rotacismo", "omision"],
                    feedbackOK: "Exacto. Es una **Dislalia**. El origen es funcional/motriz, no neurol√≥gico.",
                    feedbackMiss: "Cuidado. ¬øEl fallo es mental (organizaci√≥n) o motriz (ejecuci√≥n)? F√≠jate que comete el error siempre (sistem√°tico)."
                }
            },
            raul: { // Fonol√≥gico
                t1: {
                    keywords: ["fonologico", "retraso del habla"],
                    evidenceReq: ["secuencia", "estructura", "bosch"],
                    feedbackOK: "Bien visto. Es un **Trastorno Fonol√≥gico**. Articula bien sonidos sueltos, pero falla en la palabra.",
                    feedbackMiss: "Analiza esto: Si puede decir el sonido aislado pero falla en la frase, ¬øes muscular (dislalia) o mental (fonol√≥gico)?"
                }
            },
            angel: { // Disglosia
                t1: {
                    keywords: ["disglosia"],
                    evidenceReq: ["frenillo", "anquiloglosia", "organico"],
                    feedbackOK: "Correcto. Es una **Disglosia** debido a la alteraci√≥n org√°nica (frenillo).",
                    feedbackMiss: "F√≠jate en la 'informaci√≥n familiar'. Hay una causa f√≠sica en la lengua. Eso descarta la dislalia funcional."
                }
            },
            luis: { // Disartria
                t1: {
                    keywords: ["disartria"],
                    evidenceReq: ["espasticidad", "neurologico", "tono bajo"],
                    feedbackOK: "Acertado. La **Disartria** implica debilidad muscular de origen neurol√≥gico.",
                    feedbackMiss: "No es solo tartamudez. Lee la nota sobre 'espasticidad'. Eso indica da√±o neurol√≥gico, no solo fluidez."
                }
            }
        };

        // 5. MOTOR DE RESPUESTA (ENGINE)
        function generateResponse(caseKey, taskId, text, state) {
            const t = normText(text);
            const rule = uc3Rules[caseKey];
            const kb = knowledgeBase[caseKey];
            let responseHTML = "";

            // CABECERA DE FEEDBACK
            responseHTML += `<i>He analizado tu respuesta: "${excerpt(text)}"</i><br><br>`;

            // --- TAREA 1: IDENTIFICACI√ìN ---
            if (taskId === 1) {
                const r = rule.t1;
                // A. Check Red Flags (M√©dico/Invasivo)
                if (hasAny(t, ["cirugia", "operar", "medicamento", "farmaco"])) {
                    return responseHTML + `‚ö†Ô∏è <b>Alerta de Rol:</b> Como maestros de GEIN, nuestra competencia NO es cl√≠nica ni quir√∫rgica. <br><b>Evidencia UC3:</b> Debemos centrarnos en la prevenci√≥n y reeducaci√≥n educativa. Reenfoca tu respuesta hacia el aula.`;
                }

                // B. Check Diagn√≥stico Core
                if (hasAny(t, r.keywords)) {
                    responseHTML += `‚úÖ <b>Diagn√≥stico:</b> ${r.feedbackOK}<br>`;
                    
                    // C. Check Evidencias
                    if (hasAny(t, r.evidenceReq)) {
                        responseHTML += `üëç <b>Evidencias:</b> Has citado correctamente elementos del texto.<br>`;
                        responseHTML += `üìö <b>Fundamentaci√≥n Te√≥rica:</b> ${kb.diagnosis} ${kb.etiology}<br><br>`;
                        responseHTML += `<b>Siguiente paso:</b> ¬øPodr√≠as explicar por qu√© descartamos un origen puramente neurol√≥gico en este caso concreto?`;
                    } else {
                        responseHTML += `‚ö†Ô∏è <b>Falta Evidencia:</b> Tu etiqueta es correcta, pero no citas el texto.<br>`;
                        responseHTML += `<b>Pregunta Gu√≠a:</b> Busca en el caso palabras como "gritos", "esfuerzo" o "frenillo". ¬øCu√°l aparece y qu√© subtipo indica?`;
                    }
                } else {
                    responseHTML += `‚ùå <b>Revisi√≥n necesaria:</b> ${r.feedbackMiss}<br>`;
                    responseHTML += `<b>Pista te√≥rica:</b> Consulta la definici√≥n en '43 GEIN_UC3'.`;
                }
            }

            // --- TAREA 2: INDICADORES ---
            else if (taskId === 2) {
                const r = rule.t2;
                // Conteo simple de items
                const lines = text.split(/\n|,/).filter(l => l.length > 5);
                const count = lines.length;

                if (count < 4) {
                    responseHTML += `üìâ <b>Volumen insuficiente:</b> Detecto solo ${count} posibles indicadores. La tarea pide un an√°lisis exhaustivo (m√≠nimo 6).<br>`;
                    responseHTML += `<b>Sugerencia:</b> Relee el caso buscando: 1) S√≠ntomas f√≠sicos, 2) Conductas del ni√±o, 3) Datos m√©dicos/familiares.<br>`;
                } else {
                    const foundKw = r.keywords.filter(k => t.includes(k));
                    responseHTML += `‚úÖ <b>An√°lisis:</b> Has detectado ${count} indicadores. Coincido contigo en puntos clave como: <b>${foundKw.join(", ")}</b>.<br>`;
                    responseHTML += `üìö <b>Evidencia UC3:</b> ${kb.indicators}<br><br>`;
                    responseHTML += `<b>Reflexi√≥n:</b> De los indicadores que has listado, ¬øcu√°les son observables directamente en el aula y cu√°les provienen de informes externos?`;
                }
            }

            // --- TAREA 3: INTERVENCI√ìN ---
            else if (taskId === 3) {
                const r = rule.t3;
                const hasInclusive = hasAny(t, ["clase", "grupo", "todos", "asamblea", "aula"]);
                const hasPreventive = hasAny(t, ["prevencion", "pautas", "habitos", "higiene"]);

                if (hasInclusive && hasPreventive) {
                    responseHTML += `üåü <b>Excelente enfoque competencial:</b> Cumples los requisitos de Inclusi√≥n y Prevenci√≥n.<br>`;
                    responseHTML += `üìö <b>Respaldo Te√≥rico:</b> ${kb.intervention}<br>`;
                    responseHTML += `<b>Profundizaci√≥n:</b> ¬øC√≥mo evaluar√≠as si tu actividad inclusiva ha funcionado para ${uc3Rules[caseKey].label || "el alumno"}?`;
                } else {
                    responseHTML += `‚ö†Ô∏è <b>Ajuste Metodol√≥gico:</b><br>`;
                    if (!hasInclusive) responseHTML += `- Falta la dimensi√≥n <b>Inclusiva</b> (actividad para todo el grupo clase).<br>`;
                    if (!hasPreventive) responseHTML += `- Falta el enfoque <b>Preventivo</b> (evitar que empeore).<br>`;
                    responseHTML += `<br><b>Referencia:</b> Revisa 'Intervenci√≥n Temprana' en el PDF 43 GEIN_UC3.`;
                }
            } 
            
            else {
                responseHTML = "Por favor, especifica si est√°s respondiendo a la Tarea 1, 2 o 3.";
            }

            return responseHTML;
        }

        // 6. FUNCIONES DE LA APP (VISUALIZACI√ìN)
        const casesData = {
            marina: `<strong>Antecedentes:</strong> Marina (5 a√±os). Voz grave, esfuerzo vocal.<br><strong>S√≠ntomas:</strong> "Gallos", voz inaudible, rigidez muscular, dificultad con agudos.<br><strong>Factores:</strong> Suele gritar.<br><strong>Informe ORL:</strong> N√≥dulos vocales.`,
            anais: `<strong>Antecedentes:</strong> Ana√≠s (5 a√±os). Lenguaje "infantilizado".<br><strong>Errores (Dislalias):</strong><br>- Seseo (sigarro)<br>- Rotacismo (lat√≥n)<br>- Omisi√≥n final (coll√°)<br><em>Nota: Errores sistem√°ticos de ejecuci√≥n motriz.</em>`,
            raul: `<strong>Situaci√≥n:</strong> Ra√∫l articula bien sonidos aislados pero falla en la secuencia.<br><strong>Errores Fonol√≥gicos (Bosch 1983):</strong><br>- Met√°tesis (mil√≥n/lim√≥n)<br>- Omisi√≥n s√≠labas √°tonas.<br><em>Clave: Problema de organizaci√≥n, no muscular.</em>`,
            angel: `<strong>Relato:</strong> "Hola mi nombrle es √Ångel... teno chinco a√±os".<br><strong>Causa Org√°nica:</strong> Anquiloglosia (frenillo lingual corto). Malformaci√≥n f√≠sica.`,
            luis: `<strong>Relato:</strong> Habla lenta, costosa, mon√≥tona.<br><strong>Signos neurol√≥gicos:</strong> Debilidad y <strong>espasticidad</strong> (rigidez) en lengua y labios.`
        };

        const tasks = [
            { id: 1, title: "TAREA 1: Diagn√≥stico", desc: "Identifica el trastorno y subtipo. Justifica con evidencias del texto y teor√≠a UC3." },
            { id: 2, title: "TAREA 2: Indicadores", desc: "Lista m√≠nimo 6 indicadores de riesgo presentes en el texto." },
            { id: 3, title: "TAREA 3: Intervenci√≥n", desc: "Prop√≥n 2 actividades. Requisito: 1 inclusiva (grupo) y 1 preventiva." }
        ];

        const data = {
            degrees: [
               { id: '1', title: 'M√°ster Universitario en Formaci√≥n del Profesorado', subjects: [] },
               { id: '3', title: 'Grado Universitario en Educaci√≥n Infantil', subjects: [{code:'43GEIN', name:'43GEIN_04_A_2026-27_Dificultades en el aprendizaje, trastornos de la comunicaci√≥n y TDA / hiperactividad'}] }
            ]
        };

        const app = {
            history: [], 
            show(id) {
                document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
                document.getElementById(id).classList.remove('hidden');
                const bc = document.getElementById('breadcrumbs');
                if (id === 'view-home') { bc.classList.add('hidden'); this.history = []; } 
                else { bc.classList.remove('hidden'); this.updateBreadcrumbs(); }
            },
            updateBreadcrumbs() {
                const bc = document.getElementById('breadcrumbs');
                let text = "Inicio";
                if (this.history.length > 0) text += " > " + this.history[this.history.length-1];
                bc.innerText = "< " + text;
            },
            goHome() { this.renderDegrees(); },
            renderDegrees() {
                this.history = [];
                const g = document.getElementById('degrees-grid');
                g.innerHTML = '';
                data.degrees.forEach(d => {
                    g.innerHTML += `<div class="card"><h3>${d.title}</h3><button class="btn" onclick="app.loadDegree('${d.id}')">Ver Asignaturas</button></div>`;
                });
                this.show('view-home');
            },
            loadDegree(id) {
                const d = data.degrees.find(x => x.id === id);
                this.history = [d.title]; 
                document.getElementById('degree-title').innerText = d.title;
                const g = document.getElementById('subjects-grid');
                g.innerHTML = '';
                if(d.subjects.length === 0) g.innerHTML = "<p>No hay asignaturas disponibles en esta demo.</p>";
                d.subjects.forEach(s => {
                    g.innerHTML += `<div class="card"><h3>${s.code}</h3><p>${s.name}</p><button class="btn" onclick="app.loadSubject('${s.name}')">Acceder</button></div>`;
                });
                this.show('view-subjects');
            },
            loadSubject(fullName) {
                this.history.push("Asignatura");
                if (fullName.includes('43GEIN')) {
                    document.getElementById('unit-subject-title').innerText = fullName;
                    const g = document.getElementById('units-grid');
                    g.innerHTML = `<div class="card"><h3>Unidad Competencial 3</h3><p>Trastornos del Lenguaje.</p><button class="btn" onclick="app.loadUC3Menu()">Entrar</button></div>`;
                    this.show('view-units');
                } else {
                    alert("Solo disponible 43 GEIN UC3");
                }
            },
            loadUC3Menu() { this.history.push("UC3"); this.show('view-uc3-menu'); },
            loadUC3ActivityMenu() { this.history.push("Casos"); this.show('view-uc3-cases-menu'); },
            loadCase(caseKey) {
                const names = { marina: "Caso de Marina", anais: "Caso de Ana√≠s", raul: "Caso de Ra√∫l", angel: "Caso de √Ångel", luis: "Caso de Lu√≠s" };
                this.history.push(names[caseKey]);
                document.getElementById('case-title').innerText = names[caseKey];
                document.getElementById('case-content').innerHTML = `<div class="case-text">${casesData[caseKey]}</div>`;
                
                const tasksContainer = document.getElementById('case-tasks-container');
                tasksContainer.innerHTML = '';
                
                tasks.forEach(task => {
                    const chatId = `chat-${caseKey}-${task.id}`;
                    tasksContainer.innerHTML += `
                        <div class="task-block">
                            <div class="task-title">${task.title}</div>
                            <p class="task-desc">${task.desc}</p>
                            <div class="chat-box">
                                <div class="chat-header"><span>üí¨ Tutor Virtual AulIA (UC3)</span></div>
                                <div class="chat-messages" id="${chatId}">
                                    <div class="message msg-ai">Hola. Soy tu tutor de UC3. He le√≠do el caso. ¬øCu√°l es tu propuesta inicial bas√°ndote en el material de estudio?</div>
                                </div>
                                <div class="chat-input-area">
                                    <input type="text" class="chat-input" id="input-${chatId}" placeholder="Escribe aqu√≠..." onkeypress="if(event.key==='Enter') app.sendMessage('${caseKey}', ${task.id})">
                                    <button class="chat-btn" onclick="app.sendMessage('${caseKey}', ${task.id})">Enviar</button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                this.show('view-uc3-case-detail');
            },
            sendMessage(caseKey, taskId) {
                const chatId = `chat-${caseKey}-${taskId}`;
                const input = document.getElementById(`input-${chatId}`);
                const text = input.value.trim();
                if (!text) return;

                const msgContainer = document.getElementById(chatId);
                msgContainer.innerHTML += `<div class="message msg-user">${text}</div>`;
                input.value = '';
                msgContainer.scrollTop = msgContainer.scrollHeight;

                const loadingId = `loading-${Date.now()}`;
                msgContainer.innerHTML += `<div id="${loadingId}" class="message msg-ai" style="opacity:0.7">Consultando material UC3...</div>`;
                msgContainer.scrollTop = msgContainer.scrollHeight;

                const state = tutorMemory.get(caseKey, taskId);
                tutorMemory.pushTurn(state, "user", text);

                setTimeout(() => {
                    document.getElementById(loadingId).remove();
                    // LLAMADA AL NUEVO MOTOR DE IA
                    const response = generateResponse(caseKey, taskId, text, state);
                    
                    tutorMemory.pushTurn(state, "ai", response);
                    msgContainer.innerHTML += `<div class="message msg-ai">${response}</div>`;
                    msgContainer.scrollTop = msgContainer.scrollHeight;
                }, 800);
            },
            loadUC3PracticeLevels() { alert("Acceso restringido a actividad de evaluaci√≥n."); },
            loadUC3SimGrid(l) { },
            loadSimulations(n) { }
        };

        app.renderDegrees();
    </script>
