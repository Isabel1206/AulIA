<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AulIA - Plataforma de Simulaciones</title>
    <style>
        :root {
            --primary: #006A6A;
            --secondary: #D81B60; /* Color distintivo para MSEC */
            --bg-color: #FFFFFF;
            --card-bg: #F8F9FA;
            --text-main: #212529;
            --radius: 12px;
            --font-family: 'Segoe UI', sans-serif;
            --chat-user: #e3f2fd;
            --chat-ai: #f1f8e9;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: var(--font-family); background-color: var(--bg-color); color: var(--text-main); }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }

        header { padding: 40px 20px; text-align: center; }
        .logo-container { margin-bottom: 20px; display: flex; justify-content: center; }
        .logo-img { max-width: 300px; height: auto; }
        .hero-desc { max-width: 700px; margin: 20px auto; font-size: 1.1rem; color: #555; }

        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px; padding: 20px 0; }
        .sim-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; padding: 20px 0; }

        .card { 
            background: var(--card-bg); 
            padding: 30px; 
            border-radius: var(--radius); 
            border: 1px solid #eee;
            transition: 0.3s;
            display: flex; flex-direction: column; justify-content: space-between;
        }
        .card:hover { transform: translateY(-5px); border-color: var(--primary); box-shadow: 0 10px 20px rgba(0,0,0,0.05); }
        .card h3 { color: var(--primary); margin-bottom: 10px; font-size: 1.2rem; }
        .card p { font-size: 0.95rem; color: #444; margin-bottom: 15px; }

        .case-container {
            background: #fff; padding: 30px; border-radius: var(--radius);
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 30px;
            border-left: 5px solid var(--primary);
        }
        .case-text { font-size: 1.05rem; line-height: 1.6; color: #333; white-space: pre-line; }
        .case-text ul { margin-left: 20px; margin-top: 10px; }

        .task-block { margin-top: 40px; border-top: 1px solid #eee; padding-top: 20px; }
        .task-title { font-weight: bold; color: var(--primary); font-size: 1.1rem; margin-bottom: 10px; }
        .task-desc { margin-bottom: 15px; color: #555; }

        .chat-box {
            background: #fff; border: 1px solid #ddd; border-radius: 8px;
            margin-top: 15px; display: flex; flex-direction: column; overflow: hidden;
        }
        .chat-header { 
            background: #f4f4f4; padding: 10px 15px; font-weight: bold; color: var(--primary);
            border-bottom: 1px solid #ddd;
        }
        .chat-messages {
            height: 300px; overflow-y: auto; padding: 15px; background: #fafafa;
            display: flex; flex-direction: column; gap: 10px;
        }
        .message { padding: 10px 15px; border-radius: 12px; max-width: 85%; font-size: 0.95rem; line-height: 1.4; }
        .msg-user { align-self: flex-end; background-color: var(--chat-user); color: #004d4d; border-bottom-right-radius: 2px; }
        .msg-ai { align-self: flex-start; background-color: var(--chat-ai); color: #2e7d32; border-bottom-left-radius: 2px; border: 1px solid #c8e6c9; }

        .chat-input-area { display: flex; gap: 10px; padding: 10px; background: #fff; border-top: 1px solid #eee; }
        .chat-input { flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 6px; }
        .chat-btn { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; }
        
        .card-sim { background: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 20px; text-align: center; color: #555; cursor: default; }
        .card-sim:hover { background: #f0f0f0; cursor: pointer; }
        .btn { background: var(--primary); color: white; padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; width: 100%; margin-top: auto; }
        .hidden { display: none; }
        
        /* Navegaci√≥n mejorada */
        .breadcrumbs { margin: 20px 0; color: var(--primary); font-size: 0.9rem; display: flex; align-items: center; gap: 15px; }
        .nav-btn { cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 5px; }
        .nav-btn:hover { text-decoration: underline; }
    </style>
</head>
<body>

    <header>
        <div class="container">
            <div class="logo-container">
                <img src="logo.png" alt="Logo AulIA" class="logo-img" onerror="this.style.display='none'; document.getElementById('alt-logo').style.display='block'">
                <h1 id="alt-logo" style="display:none; color:var(--primary); font-size:2.5rem;">AulIA</h1>
            </div>
            <p class="hero-desc">Plataforma de simulaciones educativas basada en IA generativa. Practica la toma de decisiones y la reflexi√≥n docente en entornos profesionales seguros.</p>
        </div>
    </header>

    <div class="container">
        <div id="breadcrumbs" class="breadcrumbs hidden">
            <span class="nav-btn" onclick="app.goBack()">‚¨Ö Volver</span>
            <span style="color:#ccc">|</span>
            <span class="nav-btn" onclick="app.goHome()">üè† Inicio</span>
            <span id="breadcrumb-text" style="color:#666; margin-left: 10px;"></span>
        </div>
        
        <section id="view-home"><div class="grid" id="degrees-grid"></div></section>
        
        <section id="view-subjects" class="hidden">
            <h2 id="degree-title" style="margin-bottom:20px; color:var(--primary)"></h2>
            <div class="grid" id="subjects-grid"></div>
        </section>

        <section id="view-levels" class="hidden">
            <h2 id="subject-title" style="margin-bottom:20px; color:var(--primary)"></h2>
            <div class="grid">
                <div class="card"><h3>Nivel 1</h3><button class="btn" onclick="app.loadSimulations(1)">Acceder</button></div>
                <div class="card"><h3>Nivel 2</h3><button class="btn" onclick="app.loadSimulations(2)">Acceder</button></div>
                <div class="card"><h3>Nivel 3</h3><button class="btn" onclick="app.loadSimulations(3)">Acceder</button></div>
            </div>
        </section>

        <section id="view-units" class="hidden">
            <h2 id="unit-subject-title" style="margin-bottom:20px; color:var(--primary)"></h2>
            <p style="margin-bottom:20px;">Selecciona la Unidad Competencial:</p>
            <div class="grid" id="units-grid"></div>
        </section>

        <section id="view-uc3-menu" class="hidden">
            <h2 style="margin-bottom:20px; color:var(--primary)">Unidad Competencial 3</h2>
            <div class="grid">
                <div class="card">
                    <h3>Actividad de la Unidad Competencial 3</h3>
                    <p>Resoluci√≥n de casos pr√°cticos evaluables.</p>
                    <button class="btn" onclick="app.loadUC3ActivityMenu()">Acceder</button>
                </div>
                <div class="card">
                    <h3>Pr√°ctica con simulaciones</h3>
                    <p>Entrenamiento pr√°ctico con diferentes niveles.</p>
                    <button class="btn" onclick="app.loadUC3PracticeLevels()">Acceder</button>
                </div>
            </div>
        </section>

        <section id="view-uc3-cases-menu" class="hidden">
            <h2 style="margin-bottom:20px; color:var(--primary)">Selecci√≥n de Caso de Estudio</h2>
            <div class="grid">
                <div class="card"><h3>Caso de Marina</h3><button class="btn" onclick="app.loadCase('marina')">Acceder</button></div>
                <div class="card"><h3>Caso de Ana√≠s</h3><button class="btn" onclick="app.loadCase('anais')">Acceder</button></div>
                <div class="card"><h3>Caso de Ra√∫l</h3><button class="btn" onclick="app.loadCase('raul')">Acceder</button></div>
                <div class="card"><h3>Caso de √Ångel</h3><button class="btn" onclick="app.loadCase('angel')">Acceder</button></div>
                <div class="card"><h3>Caso de Lu√≠s</h3><button class="btn" onclick="app.loadCase('luis')">Acceder</button></div>
            </div>
        </section>

        <section id="view-uc3-case-detail" class="hidden">
            <h2 id="case-title" style="margin-bottom:20px; color:var(--primary)"></h2>
            <div id="case-content" class="case-container"></div>
            <div id="case-tasks-container"></div>
        </section>

        <section id="view-uc3-levels" class="hidden">
            <h2 style="margin-bottom:20px; color:var(--primary)">UC3 - Pr√°ctica con simulaciones</h2>
            <div class="grid">
                <div class="card"><h3>Nivel 1 (F√°cil)</h3><p>Casos guiados, menor complejidad.</p><button class="btn" onclick="app.loadUC3SimGrid(1)">Acceder</button></div>
                <div class="card"><h3>Nivel 2 (Intermedio)</h3><p>Casos con m√°s variables y decisiones.</p><button class="btn" onclick="app.loadUC3SimGrid(2)">Acceder</button></div>
                <div class="card"><h3>Nivel 3 (Dif√≠cil)</h3><p>Casos complejos, dilemas.</p><button class="btn" onclick="app.loadUC3SimGrid(3)">Acceder</button></div>
            </div>
        </section>

        <section id="view-uc3-sims" class="hidden">
            <h2 id="uc3-sim-title" style="margin-bottom:20px; color:var(--primary)"></h2>
            <div id="uc3-sim-grid" class="sim-grid"></div>
        </section>

        <section id="view-simulations" class="hidden">
            <h2 id="level-title" style="margin-bottom:20px; color:var(--primary)"></h2>
            <div id="simulations-grid" class="sim-grid"></div>
        </section>

        <section id="view-gein-uc4" class="hidden">
            <h2 style="margin-bottom:20px; color:var(--primary)">08 GEIN - Unidad Competencial 4</h2>
             <div class="grid">
                <div class="card">
                    <h3>Simulaciones UC4</h3>
                    <p>Entrenamiento en estimulaci√≥n del lenguaje oral.</p>
                    <button class="btn" onclick="app.loadGeinSimGrid()">Acceder</button>
                </div>
            </div>
        </section>

        <section id="view-gein-sims" class="hidden">
             <h2 style="margin-bottom:20px; color:var(--primary)">08 GEIN - Simulaciones UC4</h2>
            <div id="gein-sim-grid" class="sim-grid"></div>
        </section>

        <section id="view-msec-ua" class="hidden">
            <h2 style="margin-bottom:20px; color:#D81B60;">01MSEC: Unidades de Aprendizaje</h2>
            <div class="grid">
                <div class="card" style="border-left: 4px solid #D81B60;">
                    <h3 style="color:#D81B60;">UA1. Conceptos previos</h3>
                    <p>Aprendizaje, Personalidad y Desarrollo.</p>
                    <button class="btn" style="background:#D81B60;" onclick="app.loadMsecSimList('UA1')">Acceder</button>
                </div>
                <div class="card" style="border-left: 4px solid #D81B60;">
                    <h3 style="color:#D81B60;">UA2. Desarrollo psicol√≥gico</h3>
                    <p>Construcci√≥n de la personalidad y etapas.</p>
                    <button class="btn" style="background:#D81B60;" onclick="app.loadMsecSimList('UA2')">Acceder</button>
                </div>
                <div class="card" style="border-left: 4px solid #D81B60;">
                    <h3 style="color:#D81B60;">UA3. Proceso E-A</h3>
                    <p>Implicaciones educativas y teor√≠as.</p>
                    <button class="btn" style="background:#D81B60;" onclick="app.loadMsecSimList('UA3')">Acceder</button>
                </div>
            </div>
        </section>

        <section id="view-msec-list" class="hidden">
            <h2 id="msec-list-title" style="margin-bottom:20px; color:#D81B60;"></h2>
            <div class="sim-grid" id="msec-sim-grid"></div>
        </section>

        <section id="view-msec-detail" class="hidden">
            <h2 id="msec-sim-title" style="margin-bottom:20px; color:#D81B60;"></h2>
            <div class="case-container" style="border-left-color: #D81B60;">
                <div id="msec-sim-context" class="case-text"></div>
            </div>
            <div class="task-block">
                <div class="task-title" style="color:#D81B60;">Chat de Asesoramiento Docente (IA 01MSEC)</div>
                <div class="chat-box">
                    <div class="chat-header" style="color:#D81B60; background:#fff0f6;">üí¨ Tutor Especialista 01MSEC</div>
                    <div class="chat-messages" id="msec-chat-msgs"></div>
                    <div class="chat-input-area">
                        <input type="text" class="chat-input" id="msec-chat-input" placeholder="Consulta o argumenta tu decisi√≥n..." onkeypress="if(event.key==='Enter') app.sendMsecMessage()">
                        <button class="chat-btn" style="background:#D81B60;" onclick="app.sendMsecMessage()">Enviar</button>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <script>
        // =================================================================
        // 1. C√ìDIGO 43 GEIN (DATOS RESTAURADOS Y COMPLETOS)
        // =================================================================
        
        const tutorMemory = {
            chats: {},
            _mkKey(caseKey, taskId) { return `${caseKey}::${taskId}`; },
            get(caseKey, taskId) {
                const k = this._mkKey(caseKey, taskId);
                if (!this.chats[k]) {
                    this.chats[k] = { usedSnippets: new Set(), turns: [] };
                }
                return this.chats[k];
            },
            pushTurn(state, who, text) {
                state.turns.push({ who, text, ts: Date.now() });
            }
        };

        function normText(s) {
            return (s || "").toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').trim();
        }
        function hasAny(t, arr) { return arr.some(w => t.includes(w)); }
        function excerpt(text, n=100) { return text.length > n ? text.slice(0, n) + "..." : text; }

        // Reglas pedag√≥gicas GEIN
        const uc3Rules = {
            marina: {
                t1: { keywords: ["disfonia", "trastorno de la voz"], evidenceReq: ["nodulo", "gritos", "esfuerzo"], feedbackOK: "Correcto. Identificas la **Disfon√≠a**.", feedbackMiss: "¬øEs un problema de articulaci√≥n o de emisi√≥n (voz)?" },
                t2: { minIndicators: 6, keywords: ["grita", "esfuerzo", "voz grave", "agudos", "gallos", "inaudible", "rigidez", "nodulos"] },
                t3: { req: ["higiene vocal"], inclusive: ["sem√°foro", "cartel", "cuento"] }
            },
            anais: {
                t1: { keywords: ["dislalia"], evidenceReq: ["seseo", "rotacismo", "omision"], feedbackOK: "Exacto. Es una **Dislalia** funcional.", feedbackMiss: "¬øEl error es sistem√°tico en la articulaci√≥n?" },
                t2: { minIndicators: 4, keywords: ["seseo", "rotacismo", "omision", "infantilizado"] },
                t3: { req: ["praxias", "soplo"], inclusive: ["juego", "grupo"] }
            },
            raul: {
                t1: { keywords: ["fonologico", "retraso del habla"], evidenceReq: ["secuencia", "estructura", "bosch"], feedbackOK: "Bien visto. Es un **Trastorno Fonol√≥gico**.", feedbackMiss: "Si articula bien aislado pero falla en la palabra, es organizaci√≥n mental." },
                t2: { minIndicators: 4, keywords: ["secuencia", "estructura", "metatesis", "omision"] },
                t3: { req: ["conciencia fonologica"], inclusive: ["rimas", "palmadas"] }
            },
            angel: {
                t1: { keywords: ["disglosia"], evidenceReq: ["frenillo", "anquiloglosia"], feedbackOK: "Correcto. Es una **Disglosia** (org√°nica).", feedbackMiss: "Hay una causa f√≠sica en la lengua (frenillo)." },
                t2: { minIndicators: 3, keywords: ["frenillo", "anquiloglosia", "malformacion"] },
                t3: { req: ["no forzar", "autoestima"], inclusive: ["respeto", "diversidad"] }
            },
            luis: {
                t1: { keywords: ["disartria"], evidenceReq: ["espasticidad", "neurologico"], feedbackOK: "Acertado. La **Disartria** implica debilidad muscular neurol√≥gica.", feedbackMiss: "F√≠jate en la espasticidad y lentitud." },
                t2: { minIndicators: 4, keywords: ["espasticidad", "lenta", "monotona", "neurologico"] },
                t3: { req: ["saac", "relajacion"], inclusive: ["apoyos", "tiempo"] }
            }
        };

        const knowledgeBase = {
            general: { scope: "Evidencia: 'UC3 - Trastornos de la Comunicaci√≥n'." },
            marina: { diagnosis: "Disfon√≠a. Evidencia: N√≥dulos por abuso vocal.", etiology: "Funcional por gritos.", intervention: "Higiene vocal." },
            anais: { diagnosis: "Dislalia. Evidencia: Errores motrices sistem√°ticos.", details: "Sustituci√≥n, Omisi√≥n.", intervention: "Praxias y soplo." },
            raul: { diagnosis: "Trastorno Fonol√≥gico. Evidencia: Falla en secuencia, no en articulaci√≥n aislada.", intervention: "Conciencia fonol√≥gica." },
            angel: { diagnosis: "Disglosia. Evidencia: Anquiloglosia (frenillo corto).", intervention: "No forzar articulaci√≥n." },
            luis: { diagnosis: "Disartria. Evidencia: Espasticidad y componente neurol√≥gico.", intervention: "SAAC y relajaci√≥n." }
        };

        function generateResponse(caseKey, taskId, text, state) {
            const t = normText(text);
            const rule = uc3Rules[caseKey];
            const kb = knowledgeBase[caseKey];
            let responseHTML = `<i>He analizado tu respuesta...</i><br><br>`;

            if (taskId === 1) {
                if (hasAny(t, rule.t1.keywords)) {
                    responseHTML += `‚úÖ <b>Diagn√≥stico:</b> ${rule.t1.feedbackOK}<br>`;
                    if (hasAny(t, rule.t1.evidenceReq)) responseHTML += `üëç Has citado las evidencias clave.<br>`;
                    else responseHTML += `‚ö†Ô∏è Cita las evidencias del texto (ej. ${rule.t1.evidenceReq[0]}).<br>`;
                    responseHTML += `üìö <b>Teor√≠a:</b> ${kb.diagnosis}`;
                } else {
                    responseHTML += `‚ùå ${rule.t1.feedbackMiss}`;
                }
            } else if (taskId === 2) {
                responseHTML += `Has listado indicadores. Compara con: <b>${rule.t2.keywords.join(", ")}</b>.`;
            } else if (taskId === 3) {
                if (hasAny(t, ["grupo", "clase"]) && hasAny(t, ["prevencion", "actividad"])) {
                    responseHTML += `üåü <b>Buen enfoque inclusivo y preventivo.</b>`;
                } else {
                    responseHTML += `‚ö†Ô∏è Asegura una actividad <b>inclusiva</b> (todo el grupo) y una <b>preventiva</b>.`;
                }
            }
            return responseHTML;
        }

        const casesData = {
            marina: `
                <h3>Caso de Marina (5 a√±os) - Trastorno de la Voz</h3>
                <p><strong>Antecedentes:</strong> Marina es una ni√±a de 5 a√±os. Su constituci√≥n f√≠sica es robusta. Desde hace unos meses, la maestra y la familia notan cambios en su voz.</p>
                <p><strong>Sintomatolog√≠a observada:</strong>
                <ul>
                    <li>Voz grave para su edad y sexo.</li>
                    <li>Frecuentes "gallos" y quiebres de voz al hablar.</li>
                    <li>Momentos de afon√≠a (p√©rdida total de voz) tras el recreo.</li>
                    <li>Se observa mucha tensi√≥n y rigidez en el cuello al hablar (ingurgitaci√≥n yugular).</li>
                    <li>Dificultad para emitir tonos agudos (no puede cantar las canciones infantiles).</li>
                </ul>
                </p>
                <p><strong>Factores de riesgo:</strong> Marina suele gritar mucho en el patio y en casa para imponerse a sus hermanos. No controla el volumen de su voz.</p>
                <p><strong>Informe ORL:</strong> Se confirma la presencia de <strong>n√≥dulos vocales</strong> bilaterales (kissing nodules) debidos al abuso vocal.</p>
            `,
            anais: `
                <h3>Caso de Ana√≠s (5 a√±os) - Trastorno de Articulaci√≥n (Habla)</h3>
                <p><strong>Antecedentes:</strong> Ana√≠s, 5 a√±os. Desarrollo cognitivo normal. La maestra de Audici√≥n y Lenguaje comenta que su habla suena "infantilizada" para su edad.</p>
                <p><strong>Sintomatolog√≠a (Errores sistem√°ticos):</strong>
                <ul>
                    <li><strong>Seseo:</strong> Sustituye la /z/ por /s/ (dice "sigarro" en vez de cigarro, "sapato" en vez de zapato).</li>
                    <li><strong>Rotacismo:</strong> Sustituye la /r/ fuerte por /l/ (dice "lat√≥n" en vez de rat√≥n, "pelo" en vez de perro).</li>
                    <li><strong>Omisi√≥n de consonantes finales:</strong> Dice "coll√°" en vez de collar.</li>
                </ul>
                </p>
                <p><strong>Evaluaci√≥n:</strong> Cuando se le pide repetir el sonido aislado /r/, no puede realizar la vibraci√≥n lingual. El error es de ejecuci√≥n motriz, no de percepci√≥n.</p>
                <p><strong>Diagn√≥stico diferencial:</strong> No tiene problemas de comprensi√≥n ni de estructura de frase.</p>
            `,
            raul: `
                <h3>Caso de Ra√∫l (4 a√±os) - Trastorno Fonol√≥gico</h3>
                <p><strong>Antecedentes:</strong> Ra√∫l tiene 4 a√±os. Su habla es ininteligible para extra√±os. Los padres dicen que "tiene su propio idioma".</p>
                <p><strong>Sintomatolog√≠a:</strong>
                <ul>
                    <li>Ra√∫l es capaz de articular todos los fonemas por separado (dice "rrr", "sss", "k").</li>
                    <li>Sin embargo, al formar palabras, las desorganiza.</li>
                    <li><strong>Met√°tesis:</strong> Dice "mil√≥n" en vez de lim√≥n, "cocholate" en vez de chocolate.</li>
                    <li><strong>Omisi√≥n de s√≠labas √°tonas:</strong> Dice "pota" en vez de pelota.</li>
                </ul>
                </p>
                <p><strong>Clave del caso:</strong> A diferencia de la dislalia, Ra√∫l S√ç tiene la capacidad motriz para hacer los sonidos, pero su cerebro falla al secuenciarlos y organizarlos dentro de la palabra (Procesos de simplificaci√≥n fonol√≥gica, Laura Bosch).</p>
            `,
            angel: `
                <h3>Caso de √Ångel (5 a√±os) - Disglosia (Org√°nica)</h3>
                <p><strong>Relato del alumno:</strong> "Hola mi nombrle es √Ångel... teno chinco a√±os". Se observa dificultad clara para elevar la lengua.</p>
                <p><strong>Exploraci√≥n f√≠sica:</strong>
                <ul>
                    <li>Al pedirle que saque la lengua, esta presenta forma de coraz√≥n (muesca central).</li>
                    <li>No puede tocarse el paladar con la punta de la lengua con la boca abierta.</li>
                    <li><strong>Causa Org√°nica:</strong> Anquiloglosia (Frenillo sublingual corto).</li>
                </ul>
                </p>
                <p><strong>Implicaciones:</strong> Su dificultad no es por falta de aprendizaje (dislalia) ni por organizaci√≥n mental (fonol√≥gico), sino por una barrera f√≠sica (malformaci√≥n en √≥rgano fonoarticulatorio).</p>
            `,
            luis: `
                <h3>Caso de Lu√≠s (6 a√±os) - Disartria</h3>
                <p><strong>Antecedentes:</strong> Lu√≠s tuvo hipoxia perinatal. Tiene diagn√≥stico de Par√°lisis Cerebral Infantil (PCI) leve.</p>
                <p><strong>Sintomatolog√≠a del habla:</strong>
                <ul>
                    <li>Habla lenta, costosa y mon√≥tona.</li>
                    <li>Hiperton√≠a (espasticidad) en los labios y lengua. Le cuesta moverlos con agilidad.</li>
                    <li>Babeo ocasional (dificultad en control de saliva).</li>
                    <li>Voz soplada por falta de control respiratorio.</li>
                </ul>
                </p>
                <p><strong>Diagn√≥stico Diferencial:</strong> No es tartamudez (disfemia) porque la lentitud es por rigidez muscular, no por bloqueos. Es un trastorno de la ejecuci√≥n motora de origen neurol√≥gico.</p>
            `
        };

        const tasks = [
            { id: 1, title: "TAREA 1: Diagn√≥stico", desc: "Identifica el trastorno y subtipo. Justifica con evidencias del texto y teor√≠a UC3." },
            { id: 2, title: "TAREA 2: Indicadores", desc: "Lista m√≠nimo 6 indicadores de riesgo presentes en el texto." },
            { id: 3, title: "TAREA 3: Intervenci√≥n", desc: "Prop√≥n 2 actividades. Requisito: 1 inclusiva (grupo) y 1 preventiva." }
        ];

        // =================================================================
        // 2. NUEVA IMPLEMENTACI√ìN 01 MSEC (M√ÅSTER - IA INTELIGENTE y CONTENIDO EXPANDIDO)
        // =================================================================
        
        // Funci√≥n auxiliar para generar 20 simulaciones variadas
        function generateMsecSims(uaPrefix, uaTopic, theoryContext) {
            const sims = [];
            const contexts = ["IES Urbano", "Colegio Rural Agrupado", "Centro de Educaci√≥n Especial", "Instituto de FP B√°sica", "Colegio Biling√ºe de √âlite"];
            const students = ["Marcos", "Luc√≠a", "Ahmed", "Sof√≠a", "Javier", "Elena", "Pablo", "Noa", "David", "Carmen"];
            
            for (let i = 1; i <= 20; i++) {
                const ctx = contexts[i % contexts.length];
                const stu = students[i % students.length];
                let specificProblem = "";
                let specificSolution = "";

                if (uaTopic.includes("Conceptos")) {
                    specificProblem = `Muestra una actitud ${i % 2 === 0 ? "impulsiva y reactiva (temperamento)" : "desorganizada pero modificable (car√°cter)"}.`;
                    specificSolution = `Diferenciar si la conducta es biol√≥gica (temperamento, dif√≠cil cambio) o aprendida (car√°cter, educable). Aplicar pautas de ${i % 2 === 0 ? "autocontrol emocional" : "reestructuraci√≥n de h√°bitos"}.`;
                } else if (uaTopic.includes("Desarrollo")) {
                    specificProblem = `Est√° atravesando la etapa de ${i % 2 === 0 ? "Identidad vs Confusi√≥n" : "Industria vs Inferioridad"} y muestra rechazo a la autoridad.`;
                    specificSolution = `Entender la crisis como normativa seg√∫n Erikson. No confrontar frontalmente, sino ofrecer espacios de autonom√≠a y escucha activa.`;
                } else {
                    specificProblem = `No conecta con la explicaci√≥n del profesor sobre ${i % 2 === 0 ? "conceptos abstractos" : "procedimientos complejos"}.`;
                    specificSolution = `Aplicar la ZDP de Vygotsky: rebajar la exigencia inicial y ofrecer andamiaje (ayudas visuales o gu√≠a de pares) hasta que pueda hacerlo solo.`;
                }

                sims.push({
                    id: `${uaPrefix}-sim${i}`,
                    title: `Simulaci√≥n ${i}: ${stu} en ${ctx}`,
                    content: `
                        <strong>Contexto:</strong> ${ctx}.<br>
                        <strong>Alumno:</strong> ${stu}, ${12 + (i%5)} a√±os.<br>
                        <strong>Situaci√≥n:</strong> ${specificProblem} El docente no sabe si intervenir disciplinariamente o pedag√≥gicamente.<br>
                        <strong>Teor√≠a Clave:</strong> ${theoryContext}.
                    `,
                    solution: specificSolution
                });
            }
            return sims;
        }

        const msecData = {
            UA1: {
                title: "UA1. Conceptos previos",
                theory: "Evidencias UA1: Allport (Personalidad), Temperamento vs Car√°cter.",
                sims: generateMsecSims("ua1", "Conceptos previos", "Allport: Personalidad = Organizaci√≥n din√°mica")
            },
            UA2: {
                title: "UA2. Desarrollo psicol√≥gico",
                theory: "Evidencias UA2: Erikson (Etapas vitales), Piaget (Cognici√≥n).",
                sims: generateMsecSims("ua2", "Desarrollo psicol√≥gico", "Erikson: Crisis normativas del desarrollo")
            },
            UA3: {
                title: "UA3. Proceso E-A",
                theory: "Evidencias UA3: Vygotsky (ZDP), Ausubel (Significatividad).",
                sims: generateMsecSims("ua3", "Proceso E-A", "Vygotsky: Zona de Desarrollo Pr√≥ximo y Andamiaje")
            }
        };

        const msecBrain = {
            sessions: {}, // Memoria por sesi√≥n
            
            getSession(simId) {
                if (!this.sessions[simId]) {
                    this.sessions[simId] = { 
                        lastContext: null, // Para recordar qu√© se acaba de decir
                        history: [] 
                    };
                }
                return this.sessions[simId];
            },

            process(simId, uaKey, userText) {
                const text = normText(userText);
                const sim = msecData[uaKey].sims.find(s => s.id === simId) || { solution: "Soluci√≥n generada din√°micamente..." };
                const session = this.getSession(simId);
                let response = "";

                // 1. Detecci√≥n de petici√≥n de ayuda / No saber (IA Inteligente/Emp√°tica)
                if (hasAny(text, ["no se", "no lo se", "ni idea", "ayuda", "dime la respuesta", "solucion", "no entiendo", "me rindo", "cual es"])) {
                    response = `ü§ñ <b>Asistente IA:</b> Entiendo que este caso puede ser complejo. No te preocupes, analic√©moslo juntos.<br><br>
                            üí° <b>La soluci√≥n pedag√≥gica recomendada es:</b><br>
                            "${sim.solution}"<br><br>
                            ¬øQu√© te parece este enfoque? ¬øCrees que ser√≠a aplicable en tu contexto real?`;
                    session.lastContext = "solution_given"; // Marcamos que acabamos de dar la soluci√≥n
                } 
                // 2. Chat Conversacional (Preguntas sobre la respuesta anterior)
                else if (session.lastContext === "solution_given" && hasAny(text, ["por que", "seguro", "explica mas", "no estoy de acuerdo", "y si", "pero"])) {
                     response = `üí¨ <b>Profundizando:</b> Me preguntas sobre la soluci√≥n anterior. <br>
                     La justificamos porque la teor√≠a de esta Unidad sugiere que intervenir sobre la causa ra√≠z (sea temperamento, desarrollo o ZDP) es m√°s efectivo que solo corregir la conducta visible. <br>
                     ¬øSe te ocurre alguna alternativa a lo que propuse?`;
                }
                // 3. Evaluaci√≥n normal (estilo NotebookLM)
                else {
                    const theory = msecData[uaKey].theory;
                    if (hasAny(text, ["temperamento", "caracter", "erikson", "piaget", "vygotsky", "ausubel", "identidad", "zdp", "andamiaje"])) {
                        response = "‚úÖ <b>Muy bien fundamentado.</b> Has usado conceptos clave de la unidad y los has aplicado al problema del alumno.<br>";
                        response += `üìñ <b>Referencia:</b> ${theory}. <br>¬øHay alg√∫n otro factor del entorno que considerar√≠as?`;
                        session.lastContext = "good_answer";
                    } else {
                        response = "ü§î Tu respuesta es razonable, pero para aprobar el M√°ster necesitamos usar vocabulario t√©cnico. <br>";
                        response += "¬øPodr√≠as reformularlo usando alguno de los autores de la Unidad (Allport, Erikson, Vygotsky...)? Si no recuerdas la teor√≠a, d√≠melo y te ayudo.";
                        session.lastContext = "vague_answer";
                    }
                }
                
                return response;
            }
        };

        // Generador de simulaciones nuevas (Tarjeta accesible "M√°s simulaciones")
        const msecGenerator = {
            generate(uaKey) {
                const problems = ["Disrupci√≥n en el aula", "Apat√≠a total", "Conflicto con compa√±eros", "Falta de comprensi√≥n lectora", "Altas capacidades no detectadas"];
                const prob = problems[Math.floor(Math.random() * problems.length)];
                return {
                    id: `gen-${Date.now()}`,
                    title: `Caso Generado por IA: ${prob}`,
                    content: `<strong>Caso Nuevo:</strong> Se presenta una situaci√≥n de ${prob} en un contexto aleatorio. <br><strong>Reto:</strong> Aplica la teor√≠a de ${msecData[uaKey].theory} para resolverlo.`,
                    solution: `La soluci√≥n a "${prob}" requiere un an√°lisis individualizado. Generalmente, deber√≠as evaluar primero las necesidades del alumno y luego adaptar la metodolog√≠a.`
                };
            }
        };

        // =================================================================
        // 3. APP PRINCIPAL (L√ìGICA Y NAVEGACI√ìN)
        // =================================================================
        const data = {
            degrees: [
                { id: '1', title: 'M√°ster Universitario en Formaci√≥n del Profesorado', subjects: [{code:'01MSEC', name:'01MSEC_Aprendizaje y desarrollo de la personalidad'}] },
                { 
                    id: '3', 
                    title: 'Grado Universitario en Educaci√≥n Infantil', 
                    subjects: [
                        {code:'43GEIN', name:'43GEIN_04_A_2026-27_Dificultades en el aprendizaje, trastornos de la comunicaci√≥n y TDA / hiperactividad'},
                        {code:'08GEIN', name:'08GEIN_Estimulaci√≥n del Lenguaje Oral'} // A√±adida 08 GEIN
                    ] 
                }
            ]
        };

        const app = {
            viewStack: [], 
            currentMsecUA: null,
            currentMsecSim: null,

            show(id) {
                document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
                document.getElementById(id).classList.remove('hidden');
                
                const bc = document.getElementById('breadcrumbs');
                if (id === 'view-home') {
                    bc.classList.add('hidden');
                    this.viewStack = [];
                } else {
                    bc.classList.remove('hidden');
                    document.getElementById('breadcrumb-text').innerText = ""; 
                }

                if (this.isGoingBack) {
                    this.isGoingBack = false;
                } else {
                    if (this.viewStack.length === 0 || this.viewStack[this.viewStack.length-1] !== id) {
                        this.viewStack.push(id);
                    }
                }
            },

            goHome() { this.show('view-home'); },

            goBack() {
                if (this.viewStack.length > 1) {
                    this.viewStack.pop(); 
                    const prev = this.viewStack[this.viewStack.length - 1]; 
                    this.isGoingBack = true; 
                    this.show(prev);
                } else {
                    this.goHome();
                }
            },

            renderDegrees() {
                const g = document.getElementById('degrees-grid');
                g.innerHTML = '';
                data.degrees.forEach(d => {
                    g.innerHTML += `<div class="card"><h3>${d.title}</h3><button class="btn" onclick="app.loadDegree('${d.id}')">Ver Asignaturas</button></div>`;
                });
                this.show('view-home');
            },

            loadDegree(id) {
                const d = data.degrees.find(x => x.id === id);
                document.getElementById('degree-title').innerText = d.title;
                const g = document.getElementById('subjects-grid');
                g.innerHTML = '';
                d.subjects.forEach(s => {
                    g.innerHTML += `<div class="card"><h3>${s.code}</h3><p>${s.name}</p><button class="btn" onclick="app.loadSubject('${s.name}')">Acceder</button></div>`;
                });
                this.show('view-subjects');
            },

            loadSubject(fullName) {
                // RUTA 01 MSEC
                if (fullName.includes('01MSEC')) {
                    this.show('view-msec-ua');
                    return;
                }
                // RUTA 43 GEIN
                if (fullName.includes('43GEIN')) {
                    document.getElementById('unit-subject-title').innerText = fullName;
                    const g = document.getElementById('units-grid');
                    g.innerHTML = '';
                    g.innerHTML += `<div class="card"><h3>Unidad Competencial 3</h3><p>Trastornos del Lenguaje.</p><button class="btn" onclick="app.loadUC3Menu()">Entrar</button></div>`;
                    this.show('view-units');
                    return;
                }
                // RUTA 08 GEIN (NUEVA)
                if (fullName.includes('08GEIN')) {
                    this.show('view-gein-uc4');
                    return;
                }
                
                alert("Asignatura sin contenido demo.");
            },

            // --- L√ìGICA 08 GEIN ---
            loadGeinSimGrid() {
                 const g = document.getElementById('gein-sim-grid');
                 g.innerHTML = '';
                 // 20 simulaciones
                 for(let i=1; i<=20; i++) {
                     g.innerHTML += `<div class="card-sim"><strong>Simulaci√≥n ${i}</strong><br><small>Estimulaci√≥n Oral</small></div>`;
                 }
                 // Tarjeta extra accesible
                 g.innerHTML += `<div class="card-sim" style="border: 2px dashed var(--primary); background:#e6fcfc; cursor:pointer;" onclick="alert('Pr√≥ximamente: Entrenamiento con simulaciones extra')"><strong>‚ûï M√°s Simulaciones</strong><br><small>Entrenamiento Avanzado</small></div>`;
                 this.show('view-gein-sims');
            },

            // --- L√ìGICA 01 MSEC ---
            loadMsecSimList(uaKey) {
                this.currentMsecUA = uaKey;
                const ua = msecData[uaKey];
                document.getElementById('msec-list-title').innerText = ua.title;
                const grid = document.getElementById('msec-sim-grid');
                grid.innerHTML = '';
                
                // Tarjeta Creador (M√ÅS SIMULACIONES) - Genera una nueva cada vez
                grid.innerHTML += `
                    <div class="card-sim" style="border: 2px dashed #D81B60; background:#fff0f6;" onclick="app.loadMsecCreator()">
                        <h3 style="color:#D81B60; font-size:1rem;">‚ú® M√°s Simulaciones</h3>
                        <p>Generar caso √∫nico con IA</p>
                    </div>
                `;

                // Las 20 simulaciones est√°ticas (pero diferentes entre s√≠)
                ua.sims.forEach(sim => {
                    grid.innerHTML += `<div class="card-sim" onclick="app.loadMsecSimDetail('${sim.id}')"><strong>${sim.title}</strong></div>`;
                });
                this.show('view-msec-list');
            },

            loadMsecSimDetail(simId) {
                this.currentMsecSim = simId;
                const ua = msecData[this.currentMsecUA];
                const sim = ua.sims.find(s => s.id === simId);
                
                document.getElementById('msec-sim-title').innerText = sim.title;
                document.getElementById('msec-sim-context').innerHTML = sim.content;
                document.getElementById('msec-chat-msgs').innerHTML = `<div class="message msg-ai">Hola. Soy tu tutor IA para esta simulaci√≥n. ¬øC√≥mo resolver√≠as este caso? Si no lo sabes, d√≠melo y te ayudar√©.</div>`;
                
                this.show('view-msec-detail');
            },

            loadMsecCreator() {
                // Genera una simulaci√≥n NUEVA cada vez que se llama
                const sim = msecGenerator.generate(this.currentMsecUA);
                this.currentMsecSim = sim.id; 
                
                // Renderizar directamente (sin guardar en lista para que sea ef√≠mera y √∫nica)
                document.getElementById('msec-sim-title').innerText = sim.title;
                document.getElementById('msec-sim-context').innerHTML = sim.content;
                document.getElementById('msec-chat-msgs').innerHTML = `<div class="message msg-ai">Hola. He generado este caso √∫nico para ti. ¬øQu√© propones?</div>`;
                this.show('view-msec-detail');
            },

            sendMsecMessage() {
                const input = document.getElementById('msec-chat-input');
                const text = input.value.trim();
                if (!text) return;
                const msgs = document.getElementById('msec-chat-msgs');
                msgs.innerHTML += `<div class="message msg-user">${text}</div>`;
                input.value = "";
                msgs.scrollTop = msgs.scrollHeight;

                // Respuesta IA Inteligente
                setTimeout(() => {
                    // Si es una simulaci√≥n generada (no est√° en la lista est√°tica), pasamos el objeto generado si pudi√©ramos recuperarlo, 
                    // o usamos un fallback. Para simplificar en este c√≥digo demo, usamos l√≥gica gen√©rica si no encuentra ID.
                    const response = msecBrain.process(this.currentMsecSim, this.currentMsecUA, text);
                    msgs.innerHTML += `<div class="message msg-ai">${response}</div>`;
                    msgs.scrollTop = msgs.scrollHeight;
                }, 600);
            },

            // --- L√ìGICA 43 GEIN ---
            loadUC3Menu() { this.show('view-uc3-menu'); },
            loadUC3ActivityMenu() { this.show('view-uc3-cases-menu'); },
            loadCase(caseKey) {
                const names = { marina: "Caso de Marina", anais: "Caso de Ana√≠s", raul: "Caso de Ra√∫l", angel: "Caso de √Ångel", luis: "Caso de Lu√≠s" };
                document.getElementById('case-title').innerText = names[caseKey];
                document.getElementById('case-content').innerHTML = casesData[caseKey]; 
                
                const tasksContainer = document.getElementById('case-tasks-container');
                tasksContainer.innerHTML = '';
                tasks.forEach(task => {
                    const chatId = `chat-${caseKey}-${task.id}`;
                    tasksContainer.innerHTML += `
                        <div class="task-block">
                            <div class="task-title">${task.title}</div>
                            <p class="task-desc">${task.desc}</p>
                            <div class="chat-box">
                                <div class="chat-header"><span>üí¨ Tutor Virtual AulIA (UC3)</span></div>
                                <div class="chat-messages" id="${chatId}">
                                    <div class="message msg-ai">Hola. He analizado el caso. ¬øCu√°l es tu propuesta?</div>
                                </div>
                                <div class="chat-input-area">
                                    <input type="text" class="chat-input" id="input-${chatId}" onkeypress="if(event.key==='Enter') app.sendMessage('${caseKey}', ${task.id})">
                                    <button class="chat-btn" onclick="app.sendMessage('${caseKey}', ${task.id})">Enviar</button>
                                </div>
                            </div>
                        </div>`;
                });
                this.show('view-uc3-case-detail');
            },

            sendMessage(caseKey, taskId) {
                const chatId = `chat-${caseKey}-${taskId}`;
                const input = document.getElementById(`input-${chatId}`);
                const text = input.value.trim();
                if(!text) return;
                const msgContainer = document.getElementById(chatId);
                msgContainer.innerHTML += `<div class="message msg-user">${text}</div>`;
                input.value = '';
                
                const state = tutorMemory.get(caseKey, taskId);
                tutorMemory.pushTurn(state, "user", text);

                setTimeout(() => {
                    const response = generateResponse(caseKey, taskId, text, state);
                    tutorMemory.pushTurn(state, "ai", response);
                    msgContainer.innerHTML += `<div class="message msg-ai">${response}</div>`;
                    msgContainer.scrollTop = msgContainer.scrollHeight;
                }, 700);
            },

            loadUC3PracticeLevels() { this.show('view-uc3-levels'); },
            loadUC3SimGrid(l) { 
                document.getElementById('uc3-sim-title').innerText = "Nivel " + l;
                const g = document.getElementById('uc3-sim-grid');
                g.innerHTML = '';
                for(let i=1; i<=20; i++) g.innerHTML += `<div class="card-sim">Simulaci√≥n ${i}</div>`;
                this.show('view-uc3-sims'); 
            },
            loadSimulations(n) { 
                document.getElementById('level-title').innerText = "Nivel " + n;
                const g = document.getElementById('simulations-grid');
                g.innerHTML = '';
                for(let i=1; i<=20; i++) g.innerHTML += `<div class="card-sim">Simulaci√≥n ${i}</div>`;
                this.show('view-simulations'); 
            }
        };

        app.renderDegrees();
    </script>
</body>
</html>
